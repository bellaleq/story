<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>سیستم مدیریت جامع فروشگاه ها و صرافی ها - Real-Time</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* استایل‌های اصلی (همان کد قبلی) */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4bb543;
            --warning: #ffc107;
            --error: #dc3545;
            --info: #17a2b8;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #212529;
            --text-light: #6c757d;
            --border: #dee2e6;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --gradient-secondary: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
            --gradient-accent: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
            --gradient-success: linear-gradient(135deg, #4bb543 0%, #2e7d32 100%);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* استایل صفحات */
        .page {
            min-height: calc(100vh - 80px);
            padding: 20px 0;
        }
        
        /* استایل هدر */
        header {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo i {
            font-size: 1.8rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .realtime-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
            background: rgba(75, 181, 67, 0.1);
            color: var(--success);
        }
        
        .realtime-status.offline {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
        }
        
        /* استایل فرمها */
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h2 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.8rem;
        }
        
        .auth-header p {
            color: var(--text-light);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: var(--card-bg);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-success { 
            background: var(--gradient-success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--gradient-accent); 
            color: white; 
        }
        
        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-info { 
            background: var(--info); 
            color: white; 
        }
        
        .btn-google {
            background: white;
            color: #757575;
            border: 1px solid #ddd;
            width: 100%;
            justify-content: center;
            position: relative;
        }
        
        .btn-google:hover {
            background: #f8f9fa;
            box-shadow: var(--shadow);
        }
        
        .google-icon {
            width: 18px;
            height: 18px;
            margin-left: 10px;
        }
        
        .btn-success:hover, .btn-danger:hover, .btn-warning:hover, .btn-info:hover, .btn-google:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
            border-radius: 8px;
            padding: 4px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            font-weight: 500;
            flex: 1;
            text-align: center;
        }
        
        .tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .tab:hover:not(.active) {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        /* استایل کارتها */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        /* استایل جداول */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }
        
        .table-header h3 {
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text);
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .actions button {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        /* استایل نوتیفیکیشن */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--primary); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* استایل مودال */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: var(--primary);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: var(--error);
        }
        
        /* استایل وضعیتها */
        .user-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-approved { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        /* استایل آیتمها */
        .store-item, .approval-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }
        
        .store-item:hover, .approval-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .store-info, .approval-info {
            flex: 1;
        }
        
        .store-name, .approval-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .store-email, .approval-email {
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .store-details, .approval-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .store-actions, .approval-actions {
            display: flex;
            gap: 10px;
        }
        
        .password-cell {
            font-family: monospace;
        }
        
        /* استایل تلگرام */
        .telegram-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .telegram-status.active { background: #d4edda; color: #155724; }
        .telegram-status.error { background: #f8d7da; color: #721c24; }
        
        /* استایل چاپ */
        .print-area {
            display: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        
        /* استایل تبهای کاربر */
        .user-tab, .admin-tab {
            display: block;
        }
        
        .user-tab.hidden, .admin-tab.hidden {
            display: none;
        }
        
        /* استایل لیست محصولات برای فروش */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .checkbox-item:last-child {
            border-bottom: none;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .sold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .sold-item:last-child {
            border-bottom: none;
        }
        
        .sold-item-info {
            flex: 1;
        }
        
        .sold-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .sold-item-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        /* استایل محصولات والد و فرزند */
        .parent-item {
            background-color: #f8fafc;
        }
        
        .child-item {
            background-color: #ffffff;
        }
        
        .child-item.hidden {
            display: none;
        }
        
        .toggle-children {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .toggle-children:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* استایل لینکها */
        .auth-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            transition: var(--transition);
        }
        
        .auth-link:hover {
            color: var(--primary-dark);
        }
        
        /* استایل دکمه گوگل */
        .google-btn-container {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border);
        }
        
        .divider span {
            padding: 0 10px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* استایل های جدید برای طراحی مدرن */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .user-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .badge-success {
            background: rgba(75, 181, 67, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* استایل های جدید برای انواع فروشگاه */
        .business-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .business-type-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .business-type-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .business-type-card.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .business-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .currency-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .currency-card:hover {
            border-color: var(--primary);
        }
        
        .currency-card.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .exchange-rate {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .exchange-rate input {
            flex: 1;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-widget {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .dashboard-widget h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            padding: 10px 15px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* استایل Real-Time */
        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        .realtime-indicator.offline {
            background: var(--error);
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .realtime-update {
            background: rgba(67, 97, 238, 0.05);
            border-left: 3px solid var(--primary);
            transition: all 0.5s ease;
        }
        
        /* ================= استایل‌های جدید برای ریسپانسیو ================= */
        
        /* بهبود نمایش در دستگاه‌های بسیار کوچک */
        @media (max-width: 360px) {
            .container {
                padding: 0 10px;
            }
            
            .auth-container {
                padding: 20px 15px;
                margin: 20px auto;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
        }
        
        /* بهبود نمایش هدر در موبایل */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 1.2rem;
            }
        }
        
        /* بهبود نمایش فرم‌ها در موبایل */
        @media (max-width: 480px) {
            .form-group {
                margin-bottom: 15px;
            }
            
            input, select, textarea {
                padding: 12px;
                font-size: 14px;
            }
            
            button {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 10px;
            }
        }
        
        /* بهبود نمایش جداول در موبایل */
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 600px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 14px;
            }
        }
        
        /* بهبود نمایش کارت‌ها در موبایل */
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .quick-action-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* بهبود نمایش مودال در موبایل */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }
        }
        
        /* بهبود نمایش ناوبری تب‌ها در موبایل */
        @media (max-width: 480px) {
            #userDashboard .tabs,
            #adminDashboard .tabs {
                flex-direction: column;
            }
            
            #userDashboard .tab,
            #adminDashboard .tab {
                text-align: center;
                margin-bottom: 5px;
            }
        }
        
        /* جلوگیری از overflow در المنت‌های خاص */
        .card, .table-container, .auth-container {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* بهبود نمایش دکمه‌ها در موبایل */
        @media (max-width: 480px) {
            .user-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .user-actions button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .store-actions, .approval-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .store-actions button, .approval-actions button {
                width: 100%;
                margin-bottom: 5px;
            }
        }
        
        /* بهبود نمایش در حالت landscape موبایل */
        @media (max-height: 500px) and (orientation: landscape) {
            .auth-container {
                margin: 10px auto;
                padding: 15px;
            }
            
            .page {
                padding: 10px 0;
            }
            
            .user-info-bar {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* بهبود نمایش استور آیتم‌ها در موبایل */
        @media (max-width: 768px) {
            .store-item, .approval-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .store-actions, .approval-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* بهبود نمایش اکشن‌ها در موبایل */
        @media (max-width: 480px) {
            .actions {
                flex-direction: column;
            }
        }
        
        /* بهبود نمایش محصولات فروخته شده */
        @media (max-width: 768px) {
            .sold-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .sold-item-actions {
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }
        }
        
        /* بهبود نمایش فرم محصول در موبایل */
        @media (max-width: 768px) {
            #productForm > div {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* بهبود نمایش شبکه‌های تجاری در موبایل */
        @media (max-width: 600px) {
            .business-type-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 400px) {
            .business-type-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* بهبود نمایش شبکه ارزها در موبایل */
        @media (max-width: 500px) {
            .currency-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* بهبود نمایش ماشین حساب ارز در موبایل */
        @media (max-width: 768px) {
            .exchange-rate {
                flex-direction: column;
                gap: 8px;
            }
            
            .exchange-rate input {
                width: 100%;
            }
        }
        
        /* ================= استایل‌های جدید برای ویژگی‌های اضافه شده ================= */
        
        /* منوی موبایل */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
        }
        
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            height: 100%;
            background: var(--card-bg);
            z-index: 1000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .mobile-menu.active {
            display: block;
        }
        
        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .mobile-menu-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
        }
        
        .mobile-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-nav-item:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .mobile-nav-item.active {
            background: var(--gradient-primary);
            color: white;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .user-info {
                display: none;
            }
        }
        
        /* سیستم اطلاع‌رسانی پیشرفته */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notifications-modal .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .notifications-modal .notification-item:hover {
            background: #f8fafc;
        }
        
        .notifications-modal .notification-item.unread {
            background: rgba(67, 97, 238, 0.05);
            border-right: 3px solid var(--primary);
        }
        
        .notifications-modal .notification-time {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        /* مدیریت پروفایل */
        .profile-picture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            overflow: hidden;
            position: relative;
        }
        
        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-upload {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .profile-picture-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--border);
        }
        
        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* بهبود رمز عبور */
        .password-strength {
            margin-top: 8px;
        }
        
        .password-strength-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .password-strength-text {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        /* بخش‌بندی فرم ثبت‌نام */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .form-section-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* گریدهای واکنش‌گرا */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        /* استایل‌های مخصوص موبایل */
        .mobile-only {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- منوی موبایل -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h3>منو</h3>
            <button class="mobile-menu-close" id="mobileMenuClose">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="mobile-nav" id="mobileNav">
            <!-- محتوای منوی موبایل توسط جاوااسکریپت پر می‌شود -->
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="ti ti-building-store"></i>
                    سیستم مدیریت جامع تجارت - Real-Time
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="ti ti-menu-2"></i>
                </button>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="notification-bell" id="notificationBell">
                        <i class="ti ti-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </div>
                    <div id="userName"></div>
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="realtime-status" id="realtimeStatus">
                        <i class="ti ti-circle" style="font-size: 0.6rem;"></i>
                        <span>Real-Time</span>
                    </div>
                    <button id="userProfile" class="btn-info">
                        <i class="ti ti-user"></i>
                        پروفایل
                    </button>
                    <button id="userLogout" class="btn-danger">
                        <i class="ti ti-logout"></i>
                        خروج
                    </button>
                    <button id="adminLogout" class="btn-danger" style="display: none;">
                        <i class="ti ti-logout"></i>
                        خروج مدیر
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- صفحه ورود -->
        <div id="loginPage" class="page">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>ورود به سیستم</h2>
                    <p>سیستم مدیریت جامع فروشگاه ها و صرافی ها - Real-Time</p>
                </div>
                
                <div class="tabs">
                    <div class="tab active" id="userLoginTab">ورود تجارت</div>
                    <div class="tab" id="adminLoginTab">ورود مدیر</div>
                </div>
                
                <form id="userLoginForm">
                    <div class="form-group">
                        <label for="userEmail">ایمیل:</label>
                        <input type="email" id="userEmail" required placeholder="ایمیل خود را وارد کنید">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">رمز عبور:</label>
                        <input type="password" id="userPassword" required placeholder="رمز عبور خود را وارد کنید">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-login"></i>
                        ورود
                    </button>
                    
                    <div class="divider">
                        <span>یا</span>
                    </div>
                    
                    <div class="google-btn-container">
                        <button type="button" class="btn-google" id="googleSignInBtn">
                            <svg class="google-icon" viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            ورود با گوگل
                        </button>
                    </div>
                </form>
                
                <form id="adminLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="adminEmail">ایمیل مدیر:</label>
                        <input type="email" id="adminEmail" required placeholder="ایمیل مدیر را وارد کنید">
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">رمز عبور مدیر:</label>
                        <input type="password" id="adminPassword" required placeholder="رمز عبور مدیر را وارد کنید">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-login"></i>
                        ورود مدیر
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <span>حساب کاربری ندارید؟ </span>
                    <button id="showRegisterForm" class="btn-info" style="padding: 5px 10px;">
                        <i class="ti ti-user-plus"></i>
                        ثبت نام
                    </button>
                    <div style="margin-top: 10px;">
                        <span class="auth-link" id="forgotPassword">رمز عبور خود را فراموش کردهاید؟</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحه ثبت نام -->
        <div id="registerPage" class="page hidden">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>ثبت نام تجارت جدید</h2>
                    <p>فرم ثبت نام انواع فروشگاه ها و صرافی ها</p>
                </div>
                
                <form id="registerForm">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="ti ti-info-circle"></i>
                            اطلاعات پایه
                        </div>
                        <div class="form-group">
                            <label for="storeName">نام تجارت:</label>
                            <input type="text" id="storeName" required placeholder="نام تجارت خود را وارد کنید">
                        </div>
                        
                        <div class="form-group">
                            <label>نوع تجارت:</label>
                            <div class="business-type-grid">
                                <div class="business-type-card" data-type="retail">
                                    <div class="business-icon">
                                        <i class="ti ti-shopping-cart"></i>
                                    </div>
                                    <div>فروشگاه خرده فروشی</div>
                                </div>
                                <div class="business-type-card" data-type="wholesale">
                                    <div class="business-icon">
                                        <i class="ti ti-package"></i>
                                    </div>
                                    <div>فروشگاه عمدهفروشی</div>
                                </div>
                                <div class="business-type-card" data-type="exchange">
                                    <div class="business-icon">
                                        <i class="ti ti-currency-dollar"></i>
                                    </div>
                                    <div>صرافی ارز</div>
                                </div>
                                <div class="business-type-card" data-type="restaurant">
                                    <div class="business-icon">
                                        <i class="ti ti-tools-kitchen"></i>
                                    </div>
                                    <div>رستوران و کافه</div>
                                </div>
                                <div class="business-type-card" data-type="service">
                                    <div class="business-icon">
                                        <i class="ti ti-briefcase"></i>
                                    </div>
                                    <div>خدمات</div>
                                </div>
                                <div class="business-type-card" data-type="other">
                                    <div class="business-icon">
                                        <i class="ti ti-building-store"></i>
                                    </div>
                                    <div>سایر</div>
                                </div>
                            </div>
                            <input type="hidden" id="businessType" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="ti ti-user"></i>
                            اطلاعات مالک
                        </div>
                        <div class="form-group">
                            <label for="ownerName">نام صاحب تجارت:</label>
                            <input type="text" id="ownerName" required placeholder="نام کامل خود را وارد کنید">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">ایمیل:</label>
                            <input type="email" id="registerEmail" required placeholder="ایمیل معتبر وارد کنید">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="ti ti-lock"></i>
                            امنیت حساب
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">رمز عبور:</label>
                            <input type="password" id="registerPassword" required placeholder="رمز عبور قوی انتخاب کنید">
                            <div class="password-strength">
                                <div class="password-strength-bar">
                                    <div class="progress-fill" id="passwordStrengthBar" style="width: 0%"></div>
                                </div>
                                <div class="password-strength-text" id="passwordStrengthText">قدرت رمز عبور: ضعیف</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">تکرار رمز عبور:</label>
                            <input type="password" id="confirmPassword" required placeholder="رمز عبور را تکرار کنید">
                            <div id="passwordMatch" style="margin-top: 5px; font-size: 0.8rem;"></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-user-plus"></i>
                        ثبت نام
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="backToLogin" class="btn-info" style="width: 100%;">
                        <i class="ti ti-arrow-back"></i>
                        بازگشت به صفحه ورود
                    </button>
                </div>
            </div>
        </div>

        <!-- صفحه بازیابی رمز عبور -->
        <div id="forgotPasswordPage" class="page hidden">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>بازیابی رمز عبور</h2>
                    <p>ایمیل خود را وارد کنید تا لینک بازیابی برای شما ارسال شود</p>
                </div>
                
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="recoveryEmail">ایمیل:</label>
                        <input type="email" id="recoveryEmail" required placeholder="ایمیل خود را وارد کنید">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-send"></i>
                        ارسال لینک بازیابی
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="backToLoginFromForgot" class="btn-info" style="width: 100%;">
                        <i class="ti ti-arrow-back"></i>
                        بازگشت به صفحه ورود
                    </button>
                </div>
            </div>
        </div>

        <!-- داشبورد کاربر -->
        <div id="userDashboard" class="page hidden">
            <div id="pendingApproval" class="notification warning" style="position: relative; margin-bottom: 20px; display: none;">
                حساب شما در انتظار تأیید مدیر است. پس از تأیید میتوانید از امکانات سیستم استفاده کنید.
            </div>
            
            <div id="userDashboardContent">
                <div class="user-info-bar">
                    <div>
                        <h2 id="userStoreName">تجارت</h2>
                        <div id="userStatus"></div>
                        <div id="userBusinessType" class="badge badge-primary" style="margin-top: 5px;"></div>
                    </div>
                    <div class="user-actions">
                        <button id="backupData" class="btn-info">
                            <i class="ti ti-download"></i>
                            پشتیبانگیری
                        </button>
                        <button id="printProducts" class="btn-info">
                            <i class="ti ti-printer"></i>
                            چاپ محصولات
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="dashboard-widget">
                        <h3>اقدامات سریع</h3>
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="SystemState.switchUserTab('products')">
                                <i class="ti ti-plus"></i>
                                افزودن محصول
                            </button>
                            <button class="quick-action-btn" onclick="SystemState.switchUserTab('sales')">
                                <i class="ti ti-shopping-cart"></i>
                                ثبت فروش
                            </button>
                            <button class="quick-action-btn" onclick="SystemState.switchUserTab('exchange')">
                                <i class="ti ti-currency-dollar"></i>
                                نرخ ارز
                            </button>
                            <button class="quick-action-btn" onclick="SystemState.backupData()">
                                <i class="ti ti-download"></i>
                                پشتیبان
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-widget">
                        <h3>وضعیت امروز</h3>
                        <div id="todayStats">
                            <!-- آمار امروز اینجا نمایش داده میشود -->
                        </div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-package"></i>
                        </div>
                        <div class="stat-number" id="totalProducts">0</div>
                        <div>کل محصولات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-category"></i>
                        </div>
                        <div class="stat-number" id="totalCategories">0</div>
                        <div>دسته بندی ها</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-shopping-cart"></i>
                        </div>
                        <div class="stat-number" id="totalSold">0</div>
                        <div>فروش امروز</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-currency-dollar"></i>
                        </div>
                        <div class="stat-number" id="totalRevenue">0</div>
                        <div>درآمد امروز (افغانی)</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="products">محصولات</div>
                    <div class="tab" data-tab="categories">دسته بندی ها</div>
                    <div class="tab" data-tab="sales">فروش ها</div>
                    <div class="tab" data-tab="exchange" id="exchangeTab" style="display: none;">صرافی</div>
                    <div class="tab" data-tab="settings">تنظیمات</div>
                    <div class="tab" data-tab="profile">پروفایل</div>
                </div>
                
                <!-- تب محصولات -->
                <div id="userProductsTab" class="user-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">لیست محصولات <span class="realtime-indicator"></span></h3>
                            <div>
                                <button id="exportProducts" class="btn-info">
                                    <i class="ti ti-download"></i>
                                    خروجی
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>نام محصول</th>
                                        <th>دستهبندی</th>
                                        <th>قیمت (افغانی)</th>
                                        <th>موجودی</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- محصولات اینجا نمایش داده میشوند -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">افزودن محصول جدید</h3>
                        </div>
                        <form id="productForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="productName">نام محصول:</label>
                                    <input type="text" id="productName" required placeholder="نام محصول را وارد کنید">
                                </div>
                                <div class="form-group">
                                    <label for="productCategory">دستهبندی:</label>
                                    <select id="productCategory" required>
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">قیمت (افغانی):</label>
                                    <input type="number" id="productPrice" required placeholder="قیمت به افغانی">
                                </div>
                                <div class="form-group">
                                    <label for="productStock">موجودی:</label>
                                    <input type="number" id="productStock" required placeholder="تعداد موجودی" value="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">توضیحات:</label>
                                <textarea id="productDescription" rows="3" placeholder="توضیحات محصول (اختیاری)"></textarea>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="ti ti-plus"></i>
                                افزودن محصول
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- تب دسته بندی ها -->
                <div id="userCategoriesTab" class="user-tab hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">لیست دسته بندی ها <span class="realtime-indicator"></span></h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>نام دستهبندی</th>
                                        <th>تعداد محصولات</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody">
                                    <!-- دسته بندی ها اینجا نمایش داده میشوند -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">افزودن دستهبندی جدید</h3>
                        </div>
                        <form id="categoryForm">
                            <div class="form-group">
                                <label for="categoryName">نام دستهبندی:</label>
                                <input type="text" id="categoryName" required placeholder="نام دسته بندی را وارد کنید">
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="ti ti-plus"></i>
                                افزودن دستهبندی
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- تب فروش ها -->
                <div id="userSalesTab" class="user-tab hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">فروش های امروز <span class="realtime-indicator"></span></h3>
                        </div>
                        <div id="soldItemsList" style="padding: 20px;">
                            <!-- فروش های امروز اینجا نمایش داده میشوند -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ثبت فروش جدید</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="productsChecklist">
                                <!-- لیست محصولات برای انتخاب -->
                            </div>
                            <button id="markAsSold" class="btn-success" style="margin-top: 15px;">
                                <i class="ti ti-shopping-cart"></i>
                                ثبت به عنوان فروخته شده
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تب صرافی -->
                <div id="userExchangeTab" class="user-tab hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">مدیریت نرخ ارز <span class="realtime-indicator"></span></h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label>ارزهای فعال:</label>
                                <div class="currency-grid">
                                    <div class="currency-card" data-currency="USD">
                                        <div>💵 USD</div>
                                        <div>دلار آمریکا</div>
                                    </div>
                                    <div class="currency-card" data-currency="EUR">
                                        <div>💶 EUR</div>
                                        <div>یورو</div>
                                    </div>
                                    <div class="currency-card" data-currency="GBP">
                                        <div>💷 GBP</div>
                                        <div>پوند</div>
                                    </div>
                                    <div class="currency-card" data-currency="AED">
                                        <div>🇦🇪 AED</div>
                                        <div>درهم امارات</div>
                                    </div>
                                    <div class="currency-card" data-currency="PKR">
                                        <div>🇵🇰 PKR</div>
                                        <div>روپیه پاکستان</div>
                                    </div>
                                    <div class="currency-card" data-currency="IRR">
                                        <div>🇮🇷 IRR</div>
                                        <div>ریال ایران</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="exchangeRatesContainer">
                                <!-- نرخهای ارز اینجا نمایش داده میشوند -->
                            </div>
                            
                            <button id="saveExchangeRates" class="btn-primary" style="margin-top: 15px;">
                                <i class="ti ti-device-floppy"></i>
                                ذخیره نرخهای ارز
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ماشین حساب ارز</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: end;">
                                <div class="form-group">
                                    <label for="calcAmount">مبلغ:</label>
                                    <input type="number" id="calcAmount" placeholder="مبلغ را وارد کنید">
                                </div>
                                <div style="text-align: center; padding-bottom: 20px;">
                                    <i class="ti ti-arrow-right" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="form-group">
                                    <label for="calcResult">نتیجه:</label>
                                    <input type="text" id="calcResult" readonly style="background: #f8f9fa;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="calcFrom">از ارز:</label>
                                    <select id="calcFrom">
                                        <option value="AFN">AFN - افغانی</option>
                                        <option value="USD">USD - دلار</option>
                                        <option value="EUR">EUR - یورو</option>
                                        <option value="GBP">GBP - پوند</option>
                                        <option value="AED">AED - درهم</option>
                                        <option value="PKR">PKR - روپیه</option>
                                        <option value="IRR">IRR - ریال</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="calcTo">به ارز:</label>
                                    <select id="calcTo">
                                        <option value="USD">USD - دلار</option>
                                        <option value="EUR">EUR - یورو</option>
                                        <option value="GBP">GBP - پوند</option>
                                        <option value="AED">AED - درهم</option>
                                        <option value="PKR">PKR - روپیه</option>
                                        <option value="IRR">IRR - ریال</option>
                                        <option value="AFN">AFN - افغانی</option>
                                    </select>
                                </div>
                            </div>
                            <button id="calculateExchange" class="btn-primary">
                                <i class="ti ti-calculator"></i>
                                محاسبه
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تب تنظیمات -->
                <div id="userSettingsTab" class="user-tab hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">تنظیمات تجارت</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label for="businessAddress">آدرس تجارت:</label>
                                <textarea id="businessAddress" rows="3" placeholder="آدرس کامل تجارت"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="businessPhone">شماره تماس:</label>
                                <input type="text" id="businessPhone" placeholder="شماره تماس تجارت">
                            </div>
                            <div class="form-group">
                                <label for="businessDescription">توضیحات تجارت:</label>
                                <textarea id="businessDescription" rows="3" placeholder="توضیحات درباره تجارت شما"></textarea>
                            </div>
                            <button id="saveBusinessSettings" class="btn-primary">
                                <i class="ti ti-device-floppy"></i>
                                ذخیره تنظیمات
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">تنظیمات تلگرام</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label for="userTelegramToken">توکن ربات تلگرام:</label>
                                <input type="text" id="userTelegramToken" placeholder="توکن ربات تلگرام خود را وارد کنید">
                            </div>
                            <div class="form-group">
                                <label for="userTelegramChatId">Chat ID:</label>
                                <input type="text" id="userTelegramChatId" placeholder="Chat ID خود را وارد کنید">
                            </div>
                            <div id="telegramStatus" class="telegram-status">
                                <span id="telegramStatusText">آماده</span>
                            </div>
                            <button id="saveTelegramSettings" class="btn-primary">
                                <i class="ti ti-device-floppy"></i>
                                ذخیره تنظیمات تلگرام
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">مدیریت دادهها</h3>
                        </div>
                        <div style="padding: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="restoreData" class="btn-warning">
                                <i class="ti ti-upload"></i>
                                بازیابی
                            </button>
                            <input type="file" id="restoreFile" accept=".json" style="display: none;">
                            <button id="clearData" class="btn-danger">
                                <i class="ti ti-trash"></i>
                                پاک کردن تمام دادهها
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تب پروفایل -->
                <div id="userProfileTab" class="user-tab hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">اطلاعات حساب کاربری</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="profile-picture-container">
                                <div class="profile-picture" id="profilePicture">
                                    <!-- تصویر پروفایل اینجا نمایش داده می‌شود -->
                                </div>
                                <div class="profile-picture-upload">
                                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                                    <button type="button" class="btn-info" id="uploadProfilePictureBtn">
                                        <i class="ti ti-upload"></i>
                                        آپلود تصویر
                                    </button>
                                    <div class="profile-picture-preview" id="profilePicturePreview" style="display: none;">
                                        <!-- پیش‌نمایش تصویر اینجا نمایش داده می‌شود -->
                                    </div>
                                </div>
                            </div>
                            
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileStoreName">نام تجارت:</label>
                                    <input type="text" id="profileStoreName" required placeholder="نام تجارت">
                                </div>
                                <div class="form-group">
                                    <label for="profileOwnerName">نام صاحب تجارت:</label>
                                    <input type="text" id="profileOwnerName" required placeholder="نام صاحب تجارت">
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail">ایمیل:</label>
                                    <input type="email" id="profileEmail" required placeholder="ایمیل">
                                </div>
                                <div class="form-group">
                                    <label for="currentPassword">رمز عبور فعلی:</label>
                                    <input type="password" id="currentPassword" placeholder="رمز عبور فعلی">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">رمز عبور جدید:</label>
                                    <input type="password" id="newPassword" placeholder="رمز عبور جدید">
                                </div>
                                <div class="form-group">
                                    <label for="confirmNewPassword">تکرار رمز عبور جدید:</label>
                                    <input type="password" id="confirmNewPassword" placeholder="تکرار رمز عبور جدید">
                                </div>
                                <button type="submit" class="btn-primary">
                                    <i class="ti ti-device-floppy"></i>
                                    ذخیره تغییرات
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- داشبورد مدیر -->
        <div id="adminDashboard" class="page hidden">
            <div class="user-info-bar">
                <h2>پنل مدیریت سیستم - Real-Time</h2>
                <div class="user-actions">
                    <button id="backupAllData" class="btn-info">
                        <i class="ti ti-download"></i>
                        پشتیبانگیری کلی
                    </button>
                    <button id="createStoreAccount" class="btn-primary">
                        <i class="ti ti-plus"></i>
                        ایجاد تجارت
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-building-store"></i>
                    </div>
                    <div class="stat-number" id="adminTotalStores">0</div>
                    <div>تجارتها</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-package"></i>
                    </div>
                    <div class="stat-number" id="adminTotalProducts">0</div>
                    <div>کل محصولات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-shopping-cart"></i>
                    </div>
                    <div class="stat-number" id="adminTotalSales">0</div>
                    <div>فروش ها</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-user-plus"></i>
                    </div>
                    <div class="stat-number" id="adminNewStores">0</div>
                    <div>تجارت های جدید</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="stores">مدیریت تجارت ها</div>
                <div class="tab" data-tab="approvals">درخواست های تأیید</div>
                <div class="tab" data-tab="credentials">اطلاعات کاربران</div>
                <div class="tab" data-tab="system">تنظیمات سیستم</div>
            </div>
            
            <!-- تب مدیریت تجارت ها -->
            <div id="adminStoresTab" class="admin-tab">
                <div id="storesList">
                    <!-- لیست تجارت ها اینجا نمایش داده میشوند -->
                </div>
            </div>
            
            <!-- تب درخواست های تأیید -->
            <div id="adminApprovalsTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">درخواست های در انتظار تأیید <span class="realtime-indicator"></span></h3>
                
                <div id="approvalList">
                    <!-- درخواست های تأیید اینجا نمایش داده میشوند -->
                </div>
            </div>
            
            <!-- تب اطلاعات کاربران -->
            <div id="adminCredentialsTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">اطلاعات کاربران سیستم <span class="realtime-indicator"></span></h3>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>نام تجارت</th>
                                <th>نوع تجارت</th>
                                <th>صاحب تجارت</th>
                                <th>ایمیل</th>
                                <th>وضعیت</th>
                                <th>تاریخ ثبتنام</th>
                                <th>نوع ورود</th>
                            </tr>
                        </thead>
                        <tbody id="userCredentialsTable">
                            <!-- اطلاعات کاربران اینجا نمایش داده میشوند -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تب تنظیمات سیستم -->
            <div id="adminSystemTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">تنظیمات و مدیریت سیستم</h3>
                
                <div class="card">
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            <button id="resetAllData" class="btn-danger">
                                <i class="ti ti-refresh"></i>
                                بازنشانی تمام دادهها
                            </button>
                            <button id="viewAllData" class="btn-warning">
                                <i class="ti ti-database"></i>
                                مشاهده تمام دادهها
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label>اطلاعات مدیر سیستم:</label>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 8px;">
                                <div><strong>ایمیل:</strong> admin@example.com</div>
                                <div><strong>رمز عبور:</strong> admin123</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودالها -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ویرایش محصول</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="editProductName">نام محصول:</label>
                    <input type="text" id="editProductName" required placeholder="نام محصول">
                </div>
                <div class="form-group">
                    <label for="editProductCategory">دستهبندی:</label>
                    <select id="editProductCategory" required>
                        <option value="">انتخاب کنید</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">قیمت (افغانی):</label>
                    <input type="number" id="editProductPrice" required placeholder="قیمت به افغانی">
                </div>
                <div class="form-group">
                    <label for="editProductStock">موجودی:</label>
                    <input type="number" id="editProductStock" required placeholder="تعداد موجودی">
                </div>
                <div class="form-group">
                    <label for="editProductDescription">توضیحات:</label>
                    <textarea id="editProductDescription" rows="3" placeholder="توضیحات محصول"></textarea>
                </div>
                <button type="submit" class="btn-primary">
                    <i class="ti ti-device-floppy"></i>
                    ذخیره تغییرات
                </button>
            </form>
        </div>
    </div>

    <div id="createStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ایجاد حساب تجارت جدید</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="createStoreForm">
                <div class="form-group">
                    <label for="newStoreName">نام تجارت:</label>
                    <input type="text" id="newStoreName" required placeholder="نام تجارت">
                </div>
                <div class="form-group">
                    <label for="newBusinessType">نوع تجارت:</label>
                    <select id="newBusinessType" required>
                        <option value="retail">فروشگاه خرده فروشی</option>
                        <option value="wholesale">فروشگاه عمدهفروشی</option>
                        <option value="exchange">صرافی ارز</option>
                        <option value="restaurant">رستوران و کافه</option>
                        <option value="service">خدمات</option>
                        <option value="other">سایر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newOwnerName">نام صاحب تجارت:</label>
                    <input type="text" id="newOwnerName" required placeholder="نام صاحب تجارت">
                </div>
                <div class="form-group">
                    <label for="newStoreEmail">ایمیل:</label>
                    <input type="email" id="newStoreEmail" required placeholder="ایمیل">
                </div>
                <div class="form-group">
                    <label for="newStorePassword">رمز عبور:</label>
                    <input type="password" id="newStorePassword" required placeholder="رمز عبور">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="ti ti-plus"></i>
                    ایجاد حساب
                </button>
            </form>
        </div>
    </div>

    <!-- مودال اطلاعیه‌ها -->
    <div id="notificationsModal" class="modal notifications-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>اطلاعیه‌ها</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div id="notificationsList">
                <!-- لیست اطلاعیه‌ها اینجا نمایش داده می‌شود -->
            </div>
        </div>
    </div>

    <!-- ناحیه چاپ -->
    <div id="printArea" class="print-area"></div>

    <script>
        // سیستم مدیریت جامع فروشگاه ها و صرافی ها - نسخه کامل Real-Time
        (function() {
            'use strict';
            
            // تنظیمات Supabase
            const SUPABASE_CONFIG = {
                url: 'https://atichswkxinwqewtpvkr.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aWNoc3dreGlud3Fld3RwdmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODA2NjAsImV4cCI6MjA3NzE1NjY2MH0.UmJ7mQt4bmwIpvlrnp7J1TigQ8JqB09w_0OgcIVCtFA'
            };
            
            // تنظیمات سیستم
            const SYSTEM_CONFIG = {
                adminPhone: '0796304080',
                telegramBotToken: '8207227177:AAEp7JifbIQUCWYscaOxokpvdvTxat7EbQ8',
                telegramChatId: '8106254967',
                version: '3.0.0',
                googleClientId: '627857769759-v75t79pv4f2lu946gq6aq21888hqc8ge.apps.googleusercontent.com'
            };
            
            // مدیریت وضعیت سیستم
            const SystemState = {
                currentUser: null,
                isAdmin: false,
                users: [],
                pendingApprovals: [],
                adminCredentials: { email: 'admin@example.com', password: 'admin123' },
                supabase: null,
                realtimeSubscription: null,
                businessTypes: {
                    'retail': 'فروشگاه خرده فروشی',
                    'wholesale': 'فروشگاه عمدهفروشی',
                    'exchange': 'صرافی ارز',
                    'restaurant': 'رستوران و کافه',
                    'service': 'خدمات',
                    'other': 'سایر'
                },
                currencies: ['USD', 'EUR', 'GBP', 'AED', 'PKR', 'IRR'],
                notifications: [],
                unreadNotifications: 0,
                
                async init() {
                    try {
                        // ایجاد کلاینت Supabase
                        this.supabase = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                        
                        // تست اتصال به Supabase
                        const { data, error } = await this.supabase.from('businesses').select('*').limit(1);
                        if (error) {
                            console.warn('اتصال به Supabase ناموفق:', error);
                            this.showNotification('خطا در اتصال به سرور. لطفا بعدا تلاش کنید.', 'error');
                            return;
                        }
                        
                        await this.loadFromCloud();
                        this.setupRealtimeSubscription();
                        this.setupEventListeners();
                        this.handlePageReload();
                        this.showAppropriatePage();
                        this.setupMobileMenu();
                        this.setupPasswordStrength();
                    } catch (error) {
                        console.error('خطا در مقداردهی اولیه سیستم:', error);
                        this.showNotification('خطا در راهاندازی سیستم', 'error');
                    }
                },
                
                handlePageReload: function() {
                    // جلوگیری از رفتار پیشفرض ریلود
                    window.addEventListener('beforeunload', function(e) {
                        // ذخیره وضعیت فعلی در localStorage
                        if (SystemState.currentUser) {
                            localStorage.setItem('lastUser', JSON.stringify({
                                email: SystemState.currentUser.email,
                                isAdmin: SystemState.isAdmin,
                                timestamp: Date.now()
                            }));
                        }
                    });
                    
                    // بازیابی وضعیت پس از ریلود
                    window.addEventListener('load', function() {
                        const lastUser = localStorage.getItem('lastUser');
                        if (lastUser) {
                            const userData = JSON.parse(lastUser);
                            const now = Date.now();
                            // اگر کمتر از 5 دقیقه گذشته باشد، وضعیت را بازیابی کن
                            if (now - userData.timestamp < 5 * 60 * 1000) {
                                // بازیابی خودکار وضعیت کاربر
                                if (userData.isAdmin) {
                                    // بازیابی وضعیت ادمین
                                    document.getElementById('adminEmail').value = userData.email;
                                } else {
                                    // بازیابی وضعیت کاربر عادی
                                    document.getElementById('userEmail').value = userData.email;
                                }
                            }
                        }
                        
                        // اسکرول به بالای صفحه
                        window.scrollTo(0, 0);
                    });
                },
                
                async loadFromCloud() {
                    try {
                        // بارگذاری تمام کاربران از Supabase
                        const { data: users, error } = await this.supabase
                            .from('businesses')
                            .select('*');
                        
                        if (error) throw error;
                        
                        console.log('دادههای بارگذاری شده از Supabase:', users);
                        
                        // تفکیک کاربران تأیید شده و در انتظار تأیید
                        this.users = users.filter(user => user.approved) || [];
                        this.pendingApprovals = users.filter(user => !user.approved) || [];
                        
                        // بارگذاری اطلاعیه‌ها
                        this.loadNotifications();
                        
                        // ایجاد کاربر پیشفرض اگر هیچ کاربری وجود ندارد
                        if (this.users.length === 0 && this.pendingApprovals.length === 0) {
                            await this.createDefaultUser();
                        }
                    } catch (error) {
                        console.error('خطا در بارگذاری داده ها از ابر:', error);
                        throw error;
                    }
                },
                
                // ================= REAL-TIME SETUP =================
                setupRealtimeSubscription() {
                    // ایجاد اشتراک Real-Time برای جدول businesses
                    this.realtimeSubscription = this.supabase
                        .channel('businesses-realtime')
                        .on('postgres_changes', 
                            { 
                                event: '*', // تمام رویدادها (INSERT, UPDATE, DELETE)
                                schema: 'public', 
                                table: 'businesses' 
                            }, 
                            (payload) => {
                                console.log('تغییر Real-Time دریافت شد:', payload);
                                this.handleRealtimeChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('اشتراک Real-Time فعال شد');
                                this.updateRealtimeStatus(true);
                            } else if (status === 'CHANNEL_ERROR') {
                                console.error('خطا در اشتراک Real-Time');
                                this.updateRealtimeStatus(false);
                                this.showNotification('اتصال Real-Time قطع شد', 'error');
                            }
                        });
                },
                
                handleRealtimeChange(payload) {
                    const { eventType, new: newRecord, old: oldRecord } = payload;
                    
                    switch (eventType) {
                        case 'INSERT':
                            this.handleNewRecord(newRecord);
                            break;
                            
                        case 'UPDATE':
                            this.handleUpdatedRecord(newRecord, oldRecord);
                            break;
                            
                        case 'DELETE':
                            this.handleDeletedRecord(oldRecord);
                            break;
                    }
                    
                    // نمایش نوتیفیکیشن Real-Time
                    this.showRealtimeNotification(eventType, newRecord || oldRecord);
                },
                
                handleNewRecord(record) {
                    if (record.approved) {
                        this.users.push(record);
                    } else {
                        this.pendingApprovals.push(record);
                    }
                    
                    // به‌روزرسانی خودکار داشبوردها
                    this.updateAllDisplays();
                },
                
                handleUpdatedRecord(newRecord, oldRecord) {
                    if (newRecord.approved) {
                        // اگر کاربر تأیید شده
                        const userIndex = this.users.findIndex(u => u.id === newRecord.id);
                        if (userIndex !== -1) {
                            this.users[userIndex] = newRecord;
                        } else {
                            this.users.push(newRecord);
                            // حذف از لیست انتظار اگر وجود داشت
                            this.pendingApprovals = this.pendingApprovals.filter(u => u.id !== newRecord.id);
                        }
                    } else {
                        // اگر کاربر در انتظار تأیید است
                        const pendingIndex = this.pendingApprovals.findIndex(u => u.id === newRecord.id);
                        if (pendingIndex !== -1) {
                            this.pendingApprovals[pendingIndex] = newRecord;
                        }
                    }
                    
                    // اگر کاربر جاری به‌روزرسانی شده
                    if (this.currentUser && this.currentUser.id === newRecord.id) {
                        this.currentUser = newRecord;
                        this.renderUserDashboard();
                    }
                    
                    // به‌روزرسانی خودکار داشبوردها
                    this.updateAllDisplays();
                },
                
                handleDeletedRecord(record) {
                    // حذف رکورد از لیست‌ها
                    this.users = this.users.filter(u => u.id !== record.id);
                    this.pendingApprovals = this.pendingApprovals.filter(u => u.id !== record.id);
                    
                    // اگر کاربر جاری حذف شده
                    if (this.currentUser && this.currentUser.id === record.id) {
                        this.currentUser = null;
                        this.isAdmin = false;
                        this.showAppropriatePage();
                        this.showNotification('حساب شما حذف شده است', 'error');
                    }
                    
                    // به‌روزرسانی خودکار نمایش‌ها
                    this.updateAllDisplays();
                },
                
                updateAllDisplays() {
                    // به‌روزرسانی خودکار تمام نمایش‌ها
                    if (this.isAdmin) {
                        this.renderAdminDashboard();
                    } else if (this.currentUser) {
                        this.renderUserDashboard();
                    }
                },
                
                showRealtimeNotification(eventType, record) {
                    let message = '';
                    let type = 'info';
                    
                    switch (eventType) {
                        case 'INSERT':
                            message = `تجارت جدید "${record.store_name}" ثبت شد`;
                            type = 'success';
                            break;
                        case 'UPDATE':
                            message = `تجارت "${record.store_name}" به‌روزرسانی شد`;
                            type = 'info';
                            break;
                        case 'DELETE':
                            message = `تجارت "${record.store_name}" حذف شد`;
                            type = 'error';
                            break;
                    }
                    
                    this.showNotification(message, type);
                },
                
                updateRealtimeStatus(connected = true) {
                    const statusElement = document.getElementById('realtimeStatus');
                    if (statusElement) {
                        if (connected) {
                            statusElement.innerHTML = `
                                <i class="ti ti-circle" style="color: var(--success); font-size: 0.6rem;"></i>
                                <span>Real-Time</span>
                            `;
                            statusElement.className = 'realtime-status';
                        } else {
                            statusElement.innerHTML = `
                                <i class="ti ti-circle" style="color: var(--error); font-size: 0.6rem;"></i>
                                <span>Offline</span>
                            `;
                            statusElement.className = 'realtime-status offline';
                        }
                    }
                },
                // ================= END REAL-TIME SETUP =================
                
                async createDefaultUser() {
                    const defaultUser = {
                        store_name: "فروشگاه نمونه",
                        owner_name: "مدیر نمونه",
                        email: "store@example.com",
                        password: "123456",
                        business_type: "retail",
                        approved: true,
                        telegram_bot_token: "",
                        telegram_chat_id: "",
                        business_address: "",
                        business_phone: "",
                        business_description: "",
                        products: [
                            { id: 1, name: "گوشی موبایل سامسونگ", category: "1", price: 8500000, stock: 5, description: "گوشی موبایل سری سامسونگ", isSold: false },
                            { id: 2, name: "لپ تاپ ایسوس", category: "1", price: 15200000, stock: 3, description: "لپ تاپ گیمینگ ایسوس", isSold: false },
                            { id: 3, name: "برنج ایرانی", category: "2", price: 150000, stock: 50, description: "برنج مرغوب ایرانی", isSold: false }
                        ],
                        categories: [
                            { id: 1, name: "الکترونیک", productCount: 2 },
                            { id: 2, name: "مواد غذایی", productCount: 1 },
                            { id: 3, name: "لوازم خانگی", productCount: 0 },
                            { id: 4, name: "پوشاک", productCount: 0 }
                        ],
                        sold_items: [],
                        exchange_rates: {
                            USD: 85,
                            EUR: 95,
                            GBP: 110,
                            AED: 23,
                            PKR: 0.3,
                            IRR: 0.002
                        }
                    };
                    
                    const { data, error } = await this.supabase
                        .from('businesses')
                        .insert([defaultUser])
                        .select();
                    
                    if (!error && data && data.length > 0) {
                        this.users.push(data[0]);
                        console.log('کاربر پیشفرض ایجاد شد:', data[0]);
                    } else {
                        console.error('خطا در ایجاد کاربر پیشفرض:', error);
                    }
                },
                
                async saveUserToCloud(user) {
                    try {
                        let result;
                        
                        if (!user.id) {
                            // کاربر جدید - درج
                            const { data, error } = await this.supabase
                                .from('businesses')
                                .insert([user])
                                .select();
                            
                            if (error) throw error;
                            
                            if (data && data.length > 0) {
                                result = data[0];
                                // Real-Time به صورت خودکار توسط اشتراک مدیریت می‌شود
                            }
                        } else {
                            // کاربر موجود - به‌روزرسانی
                            const { data, error } = await this.supabase
                                .from('businesses')
                                .update(user)
                                .eq('id', user.id)
                                .select();
                            
                            if (error) throw error;
                            
                            if (data && data.length > 0) {
                                result = data[0];
                                // Real-Time به صورت خودکار توسط اشتراک مدیریت می‌شود
                            }
                        }
                        
                        return result;
                    } catch (error) {
                        console.error('خطا در ذخیره کاربر در ابر:', error);
                        throw error;
                    }
                },
                
                setupEventListeners() {
                    // مدیریت تبهای ورود
                    document.getElementById('userLoginTab').addEventListener('click', () => this.switchLoginTab('user'));
                    document.getElementById('adminLoginTab').addEventListener('click', () => this.switchLoginTab('admin'));
                    
                    // فرمهای ورود
                    document.getElementById('userLoginForm').addEventListener('submit', (e) => this.handleUserLogin(e));
                    document.getElementById('adminLoginForm').addEventListener('submit', (e) => this.handleAdminLogin(e));
                    
                    // فرم ثبتنام
                    document.getElementById('registerForm').addEventListener('submit', (e) => this.handleRegister(e));
                    
                    // انتخاب نوع تجارت
                    document.querySelectorAll('.business-type-card').forEach(card => {
                        card.addEventListener('click', () => {
                            document.querySelectorAll('.business-type-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            document.getElementById('businessType').value = card.getAttribute('data-type');
                        });
                    });
                    
                    // فرم پروفایل
                    document.getElementById('profileForm').addEventListener('submit', (e) => this.handleProfileUpdate(e));
                    
                    // فرم بازیابی رمز عبور
                    document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => this.handleForgotPassword(e));
                    
                    // دکمههای ناوبری
                    document.getElementById('showRegisterForm').addEventListener('click', () => this.showRegisterPage());
                    document.getElementById('backToLogin').addEventListener('click', () => this.showLoginPage());
                    document.getElementById('forgotPassword').addEventListener('click', () => this.showForgotPasswordPage());
                    document.getElementById('backToLoginFromForgot').addEventListener('click', () => this.showLoginPage());
                    
                    // دکمههای خروج
                    document.getElementById('userLogout').addEventListener('click', () => this.logout());
                    document.getElementById('adminLogout').addEventListener('click', () => this.logout());
                    
                    // دکمه پروفایل
                    document.getElementById('userProfile').addEventListener('click', () => this.switchUserTab('profile'));
                    
                    // فرمهای مدیریت محصولات و دسته بندی ها
                    document.getElementById('productForm').addEventListener('submit', (e) => this.handleAddProduct(e));
                    document.getElementById('categoryForm').addEventListener('submit', (e) => this.handleAddCategory(e));
                    document.getElementById('editProductForm').addEventListener('submit', (e) => this.handleEditProduct(e));
                    
                    // دکمههای فروش
                    document.getElementById('markAsSold').addEventListener('click', () => this.markProductsAsSold());
                    
                    // دکمههای پشتیبانگیری
                    document.getElementById('backupData').addEventListener('click', () => this.backupData());
                    document.getElementById('restoreData').addEventListener('click', () => this.triggerRestore());
                    document.getElementById('clearData').addEventListener('click', () => this.clearData());
                    document.getElementById('restoreFile').addEventListener('change', (e) => this.restoreData(e));
                    
                    // دکمههای پرینت
                    document.getElementById('printProducts').addEventListener('click', () => this.printProducts());
                    
                    // تنظیمات تلگرام
                    document.getElementById('saveTelegramSettings').addEventListener('click', () => this.saveTelegramSettings());
                    
                    // تنظیمات تجارت
                    document.getElementById('saveBusinessSettings').addEventListener('click', () => this.saveBusinessSettings());
                    
                    // مدیریت مودالها
                    document.querySelectorAll('.close-modal').forEach(btn => {
                        btn.addEventListener('click', () => this.closeAllModals());
                    });
                    
                    // مدیریت پنل ادمین
                    document.getElementById('createStoreAccount').addEventListener('click', () => this.openCreateStoreModal());
                    document.getElementById('createStoreForm').addEventListener('submit', (e) => this.handleCreateStore(e));
                    document.getElementById('backupAllData').addEventListener('click', () => this.backupAllData());
                    document.getElementById('resetAllData').addEventListener('click', () => this.resetAllData());
                    document.getElementById('viewAllData').addEventListener('click', () => this.viewAllData());
                    
                    // دکمه خروجی محصولات
                    document.getElementById('exportProducts').addEventListener('click', () => this.exportProducts());
                    
                    // مدیریت صرافی
                    document.getElementById('saveExchangeRates').addEventListener('click', () => this.saveExchangeRates());
                    document.getElementById('calculateExchange').addEventListener('click', () => this.calculateExchange());
                    
                    // انتخاب ارزها
                    document.querySelectorAll('.currency-card').forEach(card => {
                        card.addEventListener('click', () => {
                            card.classList.toggle('selected');
                        });
                    });
                    
                    // مدیریت تبهای کاربر و ادمین
                    document.querySelectorAll('#userDashboard .tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const tabName = e.target.getAttribute('data-tab');
                            this.switchUserTab(tabName);
                        });
                    });
                    
                    document.querySelectorAll('#adminDashboard .tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const tabName = e.target.getAttribute('data-tab');
                            this.switchAdminTab(tabName);
                        });
                    });
                    
                    // کلیک خارج از مودال برای بستن
                    window.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal')) {
                            this.closeAllModals();
                        }
                    });
                    
                    // دکمه ورود با گوگل
                    document.getElementById('googleSignInBtn').addEventListener('click', () => {
                        this.initiateGoogleSignIn();
                    });
                    
                    // مدیریت اطلاعیه‌ها
                    document.getElementById('notificationBell').addEventListener('click', () => {
                        this.openNotificationsModal();
                    });
                    
                    // مدیریت آپلود تصویر پروفایل
                    document.getElementById('uploadProfilePictureBtn').addEventListener('click', () => {
                        document.getElementById('profilePictureInput').click();
                    });
                    
                    document.getElementById('profilePictureInput').addEventListener('change', (e) => {
                        this.handleProfilePictureUpload(e);
                    });
                },
                
                // ================= سیستم اطلاع‌رسانی پیشرفته =================
                loadNotifications() {
                    // بارگذاری اطلاعیه‌ها از localStorage
                    const savedNotifications = localStorage.getItem('notifications');
                    if (savedNotifications) {
                        this.notifications = JSON.parse(savedNotifications);
                    } else {
                        // اطلاعیه‌های پیشفرض
                        this.notifications = [
                            {
                                id: 1,
                                title: 'خوش آمدید',
                                message: 'به سیستم مدیریت جامع تجارت خوش آمدید',
                                type: 'info',
                                timestamp: new Date().toISOString(),
                                read: false
                            },
                            {
                                id: 2,
                                title: 'بررسی امنیتی',
                                message: 'لطفاً رمز عبور خود را به‌روزرسانی کنید',
                                type: 'warning',
                                timestamp: new Date(Date.now() - 86400000).toISOString(), // 1 روز پیش
                                read: false
                            }
                        ];
                    }
                    
                    this.updateNotificationBadge();
                },
                
                saveNotifications() {
                    localStorage.setItem('notifications', JSON.stringify(this.notifications));
                    this.updateNotificationBadge();
                },
                
                addNotification(title, message, type = 'info') {
                    const newNotification = {
                        id: Date.now(),
                        title,
                        message,
                        type,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    this.notifications.unshift(newNotification);
                    this.saveNotifications();
                    
                    // نمایش نوتیفیکیشن لحظه‌ای
                    this.showNotification(message, type);
                },
                
                updateNotificationBadge() {
                    const badge = document.getElementById('notificationBadge');
                    this.unreadNotifications = this.notifications.filter(n => !n.read).length;
                    
                    if (badge) {
                        if (this.unreadNotifications > 0) {
                            badge.textContent = this.unreadNotifications > 99 ? '99+' : this.unreadNotifications;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                },
                
                openNotificationsModal() {
                    const modal = document.getElementById('notificationsModal');
                    const list = document.getElementById('notificationsList');
                    
                    list.innerHTML = '';
                    
                    if (this.notifications.length === 0) {
                        list.innerHTML = '<div class="empty-state"><i class="ti ti-bell"></i><p>هیچ اطلاعیه‌ای وجود ندارد</p></div>';
                    } else {
                        this.notifications.forEach(notification => {
                            const notificationItem = document.createElement('div');
                            notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                            notificationItem.innerHTML = `
                                <div>
                                    <strong>${notification.title}</strong>
                                    <p>${notification.message}</p>
                                    <div class="notification-time">${new Date(notification.timestamp).toLocaleDateString('fa-IR')}</div>
                                </div>
                            `;
                            
                            notificationItem.addEventListener('click', () => {
                                this.markNotificationAsRead(notification.id);
                                notificationItem.classList.remove('unread');
                            });
                            
                            list.appendChild(notificationItem);
                        });
                    }
                    
                    modal.style.display = 'flex';
                },
                
                markNotificationAsRead(notificationId) {
                    const notification = this.notifications.find(n => n.id === notificationId);
                    if (notification && !notification.read) {
                        notification.read = true;
                        this.saveNotifications();
                    }
                },
                
                markAllNotificationsAsRead() {
                    this.notifications.forEach(notification => {
                        notification.read = true;
                    });
                    this.saveNotifications();
                },
                
                // ================= مدیریت پروفایل کامل =================
                handleProfilePictureUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // بررسی نوع فایل
                    if (!file.type.startsWith('image/')) {
                        this.showNotification('لطفاً یک فایل تصویر انتخاب کنید', 'error');
                        return;
                    }
                    
                    // بررسی حجم فایل (حداکثر 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        this.showNotification('حجم فایل نباید بیشتر از 2 مگابایت باشد', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageData = event.target.result;
                        
                        // نمایش پیش‌نمایش
                        const preview = document.getElementById('profilePicturePreview');
                        preview.innerHTML = `<img src="${imageData}" alt="پیش‌نمایش">`;
                        preview.style.display = 'block';
                        
                        // ذخیره تصویر در پروفایل کاربر
                        if (this.currentUser) {
                            this.currentUser.profilePicture = imageData;
                            this.saveUserToCloud(this.currentUser);
                            this.updateProfilePicture();
                            this.showNotification('تصویر پروفایل با موفقیت آپلود شد', 'success');
                        }
                    };
                    
                    reader.readAsDataURL(file);
                },
                
                updateProfilePicture() {
                    const profilePicture = document.getElementById('profilePicture');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (this.currentUser && this.currentUser.profilePicture) {
                        profilePicture.innerHTML = `<img src="${this.currentUser.profilePicture}" alt="تصویر پروفایل">`;
                        userAvatar.innerHTML = `<img src="${this.currentUser.profilePicture}" alt="تصویر پروفایل">`;
                    } else {
                        const initial = this.currentUser ? this.currentUser.store_name.charAt(0) : '?';
                        profilePicture.textContent = initial;
                        userAvatar.textContent = initial;
                    }
                },
                
                // ================= منوی موبایل =================
                setupMobileMenu() {
                    const menuBtn = document.getElementById('mobileMenuBtn');
                    const menuClose = document.getElementById('mobileMenuClose');
                    const mobileMenu = document.getElementById('mobileMenu');
                    
                    menuBtn.addEventListener('click', () => {
                        mobileMenu.classList.add('active');
                        this.renderMobileMenu();
                    });
                    
                    menuClose.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                    });
                },
                
                renderMobileMenu() {
                    const mobileNav = document.getElementById('mobileNav');
                    mobileNav.innerHTML = '';
                    
                    if (this.currentUser) {
                        // منوی کاربران عادی
                        const userMenuItems = [
                            { icon: 'ti ti-package', text: 'محصولات', action: () => this.switchUserTab('products') },
                            { icon: 'ti ti-category', text: 'دسته‌بندی‌ها', action: () => this.switchUserTab('categories') },
                            { icon: 'ti ti-shopping-cart', text: 'فروش‌ها', action: () => this.switchUserTab('sales') },
                            { icon: 'ti ti-currency-dollar', text: 'صرافی', action: () => this.switchUserTab('exchange') },
                            { icon: 'ti ti-settings', text: 'تنظیمات', action: () => this.switchUserTab('settings') },
                            { icon: 'ti ti-user', text: 'پروفایل', action: () => this.switchUserTab('profile') },
                            { icon: 'ti ti-logout', text: 'خروج', action: () => this.logout() }
                        ];
                        
                        userMenuItems.forEach(item => {
                            const menuItem = document.createElement('div');
                            menuItem.className = 'mobile-nav-item';
                            menuItem.innerHTML = `
                                <i class="${item.icon}"></i>
                                <span>${item.text}</span>
                            `;
                            menuItem.addEventListener('click', () => {
                                item.action();
                                document.getElementById('mobileMenu').classList.remove('active');
                            });
                            mobileNav.appendChild(menuItem);
                        });
                    } else {
                        // منوی ورود
                        const loginMenuItems = [
                            { icon: 'ti ti-login', text: 'ورود تجارت', action: () => this.switchLoginTab('user') },
                            { icon: 'ti ti-user-plus', text: 'ثبت نام', action: () => this.showRegisterPage() }
                        ];
                        
                        loginMenuItems.forEach(item => {
                            const menuItem = document.createElement('div');
                            menuItem.className = 'mobile-nav-item';
                            menuItem.innerHTML = `
                                <i class="${item.icon}"></i>
                                <span>${item.text}</span>
                            `;
                            menuItem.addEventListener('click', () => {
                                item.action();
                                document.getElementById('mobileMenu').classList.remove('active');
                            });
                            mobileNav.appendChild(menuItem);
                        });
                    }
                },
                
                // ================= بهبود رمز عبور =================
                setupPasswordStrength() {
                    const passwordInput = document.getElementById('registerPassword');
                    const confirmInput = document.getElementById('confirmPassword');
                    
                    if (passwordInput) {
                        passwordInput.addEventListener('input', () => {
                            this.checkPasswordStrength(passwordInput.value);
                        });
                    }
                    
                    if (confirmInput) {
                        confirmInput.addEventListener('input', () => {
                            this.checkPasswordMatch();
                        });
                    }
                },
                
                checkPasswordStrength(password) {
                    let strength = 0;
                    const bar = document.getElementById('passwordStrengthBar');
                    const text = document.getElementById('passwordStrengthText');
                    
                    if (!bar || !text) return;
                    
                    // بررسی طول رمز عبور
                    if (password.length >= 8) strength += 25;
                    
                    // بررسی وجود حروف بزرگ و کوچک
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
                    
                    // بررسی وجود اعداد
                    if (/\d/.test(password)) strength += 25;
                    
                    // بررسی وجود کاراکترهای خاص
                    if (/[^a-zA-Z\d]/.test(password)) strength += 25;
                    
                    // به‌روزرسانی نوار و متن
                    bar.style.width = `${strength}%`;
                    
                    if (strength < 50) {
                        bar.style.background = 'var(--error)';
                        text.textContent = 'قدرت رمز عبور: ضعیف';
                        text.style.color = 'var(--error)';
                    } else if (strength < 75) {
                        bar.style.background = 'var(--warning)';
                        text.textContent = 'قدرت رمز عبور: متوسط';
                        text.style.color = 'var(--warning)';
                    } else {
                        bar.style.background = 'var(--success)';
                        text.textContent = 'قدرت رمز عبور: قوی';
                        text.style.color = 'var(--success)';
                    }
                },
                
                checkPasswordMatch() {
                    const password = document.getElementById('registerPassword').value;
                    const confirm = document.getElementById('confirmPassword').value;
                    const matchDiv = document.getElementById('passwordMatch');
                    
                    if (!matchDiv) return;
                    
                    if (confirm === '') {
                        matchDiv.textContent = '';
                        matchDiv.style.color = '';
                    } else if (password === confirm) {
                        matchDiv.textContent = '✓ رمز عبور مطابقت دارد';
                        matchDiv.style.color = 'var(--success)';
                    } else {
                        matchDiv.textContent = '✗ رمز عبور مطابقت ندارد';
                        matchDiv.style.color = 'var(--error)';
                    }
                },
                
                // توابع باقی مانده (همان کد قبلی)...
                // ... [بقیه توابع بدون تغییر]
                
                switchLoginTab(tab) {
                    const userTab = document.getElementById('userLoginTab');
                    const adminTab = document.getElementById('adminLoginTab');
                    const userForm = document.getElementById('userLoginForm');
                    const adminForm = document.getElementById('adminLoginForm');
                    
                    if (tab === 'user') {
                        userTab.classList.add('active');
                        adminTab.classList.remove('active');
                        userForm.style.display = 'block';
                        adminForm.style.display = 'none';
                    } else {
                        userTab.classList.remove('active');
                        adminTab.classList.add('active');
                        userForm.style.display = 'none';
                        adminForm.style.display = 'block';
                    }
                },
                
                showAppropriatePage() {
                    const loginPage = document.getElementById('loginPage');
                    const registerPage = document.getElementById('registerPage');
                    const forgotPasswordPage = document.getElementById('forgotPasswordPage');
                    const userDashboard = document.getElementById('userDashboard');
                    const adminDashboard = document.getElementById('adminDashboard');
                    const userInfo = document.getElementById('userInfo');
                    const userLogout = document.getElementById('userLogout');
                    const adminLogout = document.getElementById('adminLogout');
                    
                    // مخفی کردن تمام صفحات
                    loginPage.classList.add('hidden');
                    registerPage.classList.add('hidden');
                    forgotPasswordPage.classList.add('hidden');
                    userDashboard.classList.add('hidden');
                    adminDashboard.classList.add('hidden');
                    userInfo.style.display = 'none';
                    
                    if (this.currentUser) {
                        userInfo.style.display = 'flex';
                        if (this.isAdmin) {
                            adminDashboard.classList.remove('hidden');
                            userLogout.style.display = 'none';
                            adminLogout.style.display = 'block';
                            this.renderAdminDashboard();
                        } else {
                            userDashboard.classList.remove('hidden');
                            userLogout.style.display = 'block';
                            adminLogout.style.display = 'none';
                            this.renderUserDashboard();
                        }
                    } else {
                        loginPage.classList.remove('hidden');
                    }
                },
                
                showLoginPage() {
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('registerPage').classList.add('hidden');
                    document.getElementById('forgotPasswordPage').classList.add('hidden');
                },
                
                showRegisterPage() {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('registerPage').classList.remove('hidden');
                    document.getElementById('forgotPasswordPage').classList.add('hidden');
                },
                
                showForgotPasswordPage() {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('registerPage').classList.add('hidden');
                    document.getElementById('forgotPasswordPage').classList.remove('hidden');
                },
                
                async handleUserLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('userEmail').value;
                    const password = document.getElementById('userPassword').value;
                    
                    try {
                        // جستجو در کاربران تأیید شده
                        let user = this.users.find(u => u.email === email && u.password === password && u.approved);
                        
                        if (!user) {
                            // جستجو در کاربران در انتظار تأیید
                            user = this.pendingApprovals.find(u => u.email === email && u.password === password);
                            if (user) {
                                this.currentUser = user;
                                this.isAdmin = false;
                                this.showAppropriatePage();
                                this.showNotification('حساب شما در انتظار تأیید مدیر است', 'warning');
                                return;
                            }
                        }
                        
                        if (user) {
                            this.currentUser = user;
                            this.isAdmin = false;
                            this.showAppropriatePage();
                            this.showNotification('ورود موفقیتآمیز', 'success');
                            this.addNotification('ورود موفق', `شما با موفقیت به سیستم وارد شدید.`, 'success');
                        } else {
                            this.showNotification('ایمیل یا رمز عبور اشتباه است', 'error');
                        }
                    } catch (error) {
                        console.error('خطا در ورود:', error);
                        this.showNotification('خطا در ورود به سیستم', 'error');
                    }
                },
                
                async handleAdminLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('adminEmail').value;
                    const password = document.getElementById('adminPassword').value;
                    
                    if (email === this.adminCredentials.email && password === this.adminCredentials.password) {
                        this.currentUser = { store_name: 'مدیر سیستم', owner_name: 'مدیر', email: email };
                        this.isAdmin = true;
                        this.showAppropriatePage();
                        this.showNotification('ورود مدیر موفقیتآمیز', 'success');
                        this.addNotification('ورود مدیر', `مدیر سیستم با موفقیت وارد شد.`, 'success');
                    } else {
                        this.showNotification('ایمیل یا رمز عبور مدیر اشتباه است', 'error');
                    }
                },
                
                async handleRegister(e) {
                    e.preventDefault();
                    const storeName = document.getElementById('storeName').value;
                    const ownerName = document.getElementById('ownerName').value;
                    const email = document.getElementById('registerEmail').value;
                    const password = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const businessType = document.getElementById('businessType').value;
                    
                    if (!businessType) {
                        this.showNotification('لطفا نوع تجارت را انتخاب کنید', 'error');
                        return;
                    }
                    
                    // بررسی تطابق رمز عبور
                    if (password !== confirmPassword) {
                        this.showNotification('رمز عبور و تکرار آن مطابقت ندارند', 'error');
                        return;
                    }
                    
                    // بررسی قدرت رمز عبور
                    if (password.length < 6) {
                        this.showNotification('رمز عبور باید حداقل 6 کاراکتر باشد', 'error');
                        return;
                    }
                    
                    // بررسی وجود ایمیل
                    if (this.users.find(u => u.email === email) || this.pendingApprovals.find(u => u.email === email)) {
                        this.showNotification('این ایمیل قبلاً ثبت نام شده است', 'error');
                        return;
                    }
                    
                    // ایجاد کاربر جدید
                    const newUser = {
                        store_name: storeName,
                        owner_name: ownerName,
                        email: email,
                        password: password,
                        business_type: businessType,
                        approved: false, // کاربران معمولی نیاز به تأیید دارند
                        telegram_bot_token: "",
                        telegram_chat_id: "",
                        business_address: "",
                        business_phone: "",
                        business_description: "",
                        products: [],
                        categories: [
                            { id: 1, name: "الکترونیک", productCount: 0 },
                            { id: 2, name: "مواد غذایی", productCount: 0 },
                            { id: 3, name: "لوازم خانگی", productCount: 0 },
                            { id: 4, name: "پوشاک", productCount: 0 }
                        ],
                        sold_items: [],
                        exchange_rates: {
                            USD: 85,
                            EUR: 95,
                            GBP: 110,
                            AED: 23,
                            PKR: 0.3,
                            IRR: 0.002
                        }
                    };
                    
                    try {
                        const savedUser = await this.saveUserToCloud(newUser);
                        if (savedUser) {
                            this.pendingApprovals.push(savedUser);
                            this.showNotification('ثبت نام موفقیتآمیز. منتظر تأیید مدیر باشید', 'success');
                            this.showLoginPage();
                            
                            // ارسال پیام به مدیر
                            this.sendToAdminTelegram(
                                `🏪 درخواست ثبت نام جدید\n\n` +
                                `تجارت: ${storeName}\n` +
                                `نوع: ${this.businessTypes[businessType]}\n` +
                                `صاحب: ${ownerName}\n` +
                                `ایمیل: ${email}\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}\n\n` +
                                `لطفا به پنل مدیریت مراجعه کنید.`
                            );
                            
                            this.addNotification('ثبت نام جدید', `تجارت ${storeName} درخواست ثبت نام داده است.`, 'info');
                        }
                    } catch (error) {
                        console.error('خطا در ثبت نام:', error);
                        this.showNotification('خطا در ثبت نام', 'error');
                    }
                },
                
                async handleCreateStore(e) {
                    e.preventDefault();
                    const storeName = document.getElementById('newStoreName').value;
                    const businessType = document.getElementById('newBusinessType').value;
                    const ownerName = document.getElementById('newOwnerName').value;
                    const email = document.getElementById('newStoreEmail').value;
                    const password = document.getElementById('newStorePassword').value;
                    
                    // بررسی وجود ایمیل
                    if (this.users.find(u => u.email === email) || this.pendingApprovals.find(u => u.email === email)) {
                        this.showNotification('این ایمیل قبلاً ثبت نام شده است', 'error');
                        return;
                    }
                    
                    // ایجاد کاربر جدید
                    const newUser = {
                        store_name: storeName,
                        owner_name: ownerName,
                        email: email,
                        password: password,
                        business_type: businessType,
                        approved: true,
                        telegram_bot_token: "",
                        telegram_chat_id: "",
                        business_address: "",
                        business_phone: "",
                        business_description: "",
                        products: [],
                        categories: [
                            { id: 1, name: "الکترونیک", productCount: 0 },
                            { id: 2, name: "مواد غذایی", productCount: 0 },
                            { id: 3, name: "لوازم خانگی", productCount: 0 },
                            { id: 4, name: "پوشاک", productCount: 0 }
                        ],
                        sold_items: [],
                        exchange_rates: {
                            USD: 85,
                            EUR: 95,
                            GBP: 110,
                            AED: 23,
                            PKR: 0.3,
                            IRR: 0.002
                        }
                    };
                    
                    try {
                        const savedUser = await this.saveUserToCloud(newUser);
                        if (savedUser) {
                            this.users.push(savedUser);
                            this.closeAllModals();
                            this.renderAdminDashboard();
                            
                            this.showNotification(`حساب تجارت ${storeName} با موفقیت ایجاد شد`, 'success');
                            
                            // ارسال پیام به مدیر
                            this.sendToAdminTelegram(
                                `✅ حساب جدید ایجاد شد\n\n` +
                                `تجارت: ${storeName}\n` +
                                `نوع: ${this.businessTypes[businessType]}\n` +
                                `صاحب: ${ownerName}\n` +
                                `ایمیل: ${email}\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        }
                    } catch (error) {
                        console.error('خطا در ایجاد تجارت:', error);
                        this.showNotification('خطا در ایجاد تجارت', 'error');
                    }
                },
                
                async handleProfileUpdate(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const storeName = document.getElementById('profileStoreName').value;
                    const ownerName = document.getElementById('profileOwnerName').value;
                    const email = document.getElementById('profileEmail').value;
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                    
                    // بررسی تغییر ایمیل
                    if (email !== this.currentUser.email) {
                        // بررسی وجود ایمیل جدید
                        if (this.users.find(u => u.email === email && u.id !== this.currentUser.id) || 
                            this.pendingApprovals.find(u => u.email === email)) {
                            this.showNotification('این ایمیل قبلاً توسط کاربر دیگری استفاده شده است', 'error');
                            return;
                        }
                    }
                    
                    // بررسی تغییر رمز عبور
                    if (newPassword) {
                        if (newPassword !== confirmNewPassword) {
                            this.showNotification('رمز عبور جدید و تکرار آن مطابقت ندارند', 'error');
                            return;
                        }
                        
                        if (!currentPassword) {
                            this.showNotification('برای تغییر رمز عبور، رمز عبور فعلی را وارد کنید', 'error');
                            return;
                        }
                        
                        if (currentPassword !== this.currentUser.password) {
                            this.showNotification('رمز عبور فعلی اشتباه است', 'error');
                            return;
                        }
                        
                        this.currentUser.password = newPassword;
                    }
                    
                    // بهروزرسانی اطلاعات
                    this.currentUser.store_name = storeName;
                    this.currentUser.owner_name = ownerName;
                    this.currentUser.email = email;
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.showNotification('پروفایل با موفقیت بهروزرسانی شد', 'success');
                        this.renderUserDashboard();
                        
                        // پاک کردن فیلدهای رمز عبور
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmNewPassword').value = '';
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `👤 پروفایل بهروزرسانی شد\n\n` +
                            `تغییرات در اطلاعات حساب کاربری شما اعمال شد.\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        console.error('خطا در بهروزرسانی پروفایل:', error);
                        this.showNotification('خطا در بهروزرسانی پروفایل', 'error');
                    }
                },
                
                async handleForgotPassword(e) {
                    e.preventDefault();
                    const email = document.getElementById('recoveryEmail').value;
                    
                    // در اینجا باید با سرویس ایمیل واقعی یکپارچه شود
                    // برای نمونه، ما فقط یک پیام نمایش میدهیم
                    
                    this.showNotification('لینک بازیابی رمز عبور به ایمیل شما ارسال شد', 'success');
                    setTimeout(() => {
                        this.showLoginPage();
                    }, 3000);
                },
                
                async logout() {
                    this.currentUser = null;
                    this.isAdmin = false;
                    this.showAppropriatePage();
                    this.showNotification('خروج موفقیتآمیز', 'info');
                },
                
                renderUserDashboard() {
                    if (!this.currentUser) return;
                    
                    // بهروزرسانی اطلاعات کاربر
                    document.getElementById('userStoreName').textContent = this.currentUser.store_name;
                    document.getElementById('userName').textContent = this.currentUser.store_name;
                    this.updateProfilePicture();
                    document.getElementById('userBusinessType').textContent = this.businessTypes[this.currentUser.business_type] || 'نامشخص';
                    
                    // نمایش وضعیت تأیید کاربر
                    const userStatusElement = document.getElementById('userStatus');
                    const pendingApprovalElement = document.getElementById('pendingApproval');
                    const userDashboardContent = document.getElementById('userDashboardContent');
                    const exchangeTab = document.getElementById('exchangeTab');
                    
                    if (this.currentUser.approved) {
                        userStatusElement.innerHTML = '<span class="user-status status-approved">تأیید شده</span>';
                        pendingApprovalElement.style.display = 'none';
                        userDashboardContent.style.display = 'block';
                        
                        // نمایش تب صرافی فقط برای صرافی ها
                        if (this.currentUser.business_type === 'exchange') {
                            exchangeTab.style.display = 'block';
                        } else {
                            exchangeTab.style.display = 'none';
                        }
                        
                        // بهروزرسانی آمار
                        this.updateUserStats();
                        
                        // رندر محصولات و دسته بندی ها
                        this.renderUserProducts();
                        this.renderUserCategories();
                        this.renderUserSoldItems();
                        this.populateUserCategoryDropdowns();
                        this.updateUserProductsChecklist();
                        
                        // بارگذاری تنظیمات تلگرام کاربر
                        if (document.getElementById('userTelegramToken')) {
                            document.getElementById('userTelegramToken').value = this.currentUser.telegram_bot_token || '';
                            document.getElementById('userTelegramChatId').value = this.currentUser.telegram_chat_id || '';
                        }
                        
                        // بارگذاری تنظیمات تجارت
                        if (document.getElementById('businessAddress')) {
                            document.getElementById('businessAddress').value = this.currentUser.business_address || '';
                            document.getElementById('businessPhone').value = this.currentUser.business_phone || '';
                            document.getElementById('businessDescription').value = this.currentUser.business_description || '';
                        }
                        
                        // بارگذاری اطلاعات پروفایل
                        if (document.getElementById('profileStoreName')) {
                            document.getElementById('profileStoreName').value = this.currentUser.store_name;
                            document.getElementById('profileOwnerName').value = this.currentUser.owner_name;
                            document.getElementById('profileEmail').value = this.currentUser.email;
                        }
                        
                        // رندر نرخهای ارز
                        this.renderExchangeRates();
                    } else {
                        userStatusElement.innerHTML = '<span class="user-status status-pending">در انتظار تأیید</span>';
                        pendingApprovalElement.style.display = 'block';
                        userDashboardContent.style.display = 'none';
                    }
                },
                
                updateUserStats() {
                    if (!this.currentUser) return;
                    
                    document.getElementById('totalProducts').textContent = this.currentUser.products ? this.currentUser.products.length : 0;
                    document.getElementById('totalCategories').textContent = this.currentUser.categories ? this.currentUser.categories.length : 0;
                    
                    // تعداد فروش امروز
                    const today = new Date().toDateString();
                    const todaySales = this.currentUser.sold_items ? this.currentUser.sold_items.filter(item => 
                        new Date(item.soldAt).toDateString() === today
                    ).length : 0;
                    document.getElementById('totalSold').textContent = todaySales;
                    
                    // درآمد امروز
                    const todayRevenue = this.currentUser.sold_items ? this.currentUser.sold_items
                        .filter(item => new Date(item.soldAt).toDateString() === today)
                        .reduce((total, item) => total + item.price, 0) : 0;
                    document.getElementById('totalRevenue').textContent = todayRevenue.toLocaleString('fa-IR');
                },
                
                renderUserProducts() {
                    if (!this.currentUser) return;
                    
                    const tbody = document.getElementById('productsTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    // بررسی وجود محصولات
                    if (!this.currentUser.products || this.currentUser.products.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-light);">
                                    <div class="empty-state">
                                        <i class="ti ti-package"></i>
                                        <p>هیچ محصولی ثبت نشده است</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    this.currentUser.products.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${this.getUserCategoryName(product.category)}</td>
                            <td>${product.price.toLocaleString('fa-IR')}</td>
                            <td>${product.stock}</td>
                            <td>${product.isSold ? '<span class="badge badge-danger">فروخته شده</span>' : '<span class="badge badge-success">موجود</span>'}</td>
                            <td class="actions">
                                <button class="btn-success" onclick="SystemState.openEditProductModal(${product.id})">ویرایش</button>
                                <button class="btn-danger" onclick="SystemState.deleteUserProduct(${product.id})">حذف</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                },
                
                renderUserCategories() {
                    if (!this.currentUser) return;
                    
                    const tbody = document.getElementById('categoriesTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    // بررسی وجود دسته بندی ها
                    if (!this.currentUser.categories || this.currentUser.categories.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; color: var(--text-light);">
                                    <div class="empty-state">
                                        <i class="ti ti-category"></i>
                                        <p>هیچ دسته بندی ثبت نشده است</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    this.currentUser.categories.forEach(category => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category.name}</td>
                            <td>${category.productCount || 0}</td>
                            <td class="actions">
                                <button class="btn-success" onclick="SystemState.editUserCategory(${category.id})">ویرایش</button>
                                <button class="btn-danger" onclick="SystemState.deleteUserCategory(${category.id})">حذف</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                },
                
                renderUserSoldItems() {
                    if (!this.currentUser) return;
                    
                    const soldItemsList = document.getElementById('soldItemsList');
                    if (!soldItemsList) return;
                    
                    soldItemsList.innerHTML = '';
                    
                    // نمایش فقط فروش های امروز
                    const today = new Date().toDateString();
                    const todaySales = this.currentUser.sold_items ? this.currentUser.sold_items.filter(item => 
                        new Date(item.soldAt).toDateString() === today
                    ) : [];
                    
                    if (todaySales.length === 0) {
                        soldItemsList.innerHTML = '<div class="empty-state"><i class="ti ti-shopping-cart"></i><p>هیچ فروشی برای امروز ثبت نشده است</p></div>';
                        return;
                    }
                    
                    todaySales.forEach((item, index) => {
                        const soldItem = document.createElement('div');
                        soldItem.className = 'sold-item';
                        soldItem.innerHTML = `
                            <div class="sold-item-info">
                                <div class="sold-item-name">${item.productName}</div>
                                <div class="sold-item-details">
                                    قیمت: ${item.price.toLocaleString('fa-IR')} افغانی | 
                                    دسته بندی: ${this.getUserCategoryName(item.category)} |
                                    زمان: ${new Date(item.soldAt).toLocaleTimeString('fa-IR')}
                                </div>
                            </div>
                            <div class="sold-item-actions">
                                <button class="btn-warning" onclick="SystemState.returnProduct(${index})">بازگرداندن</button>
                            </div>
                        `;
                        soldItemsList.appendChild(soldItem);
                    });
                },
                
                populateUserCategoryDropdowns() {
                    if (!this.currentUser || !this.currentUser.categories) return;
                    
                    const categorySelects = [
                        document.getElementById('productCategory'),
                        document.getElementById('editProductCategory')
                    ];
                    
                    categorySelects.forEach(select => {
                        if (select) {
                            // حفظ مقدار فعلی
                            const currentValue = select.value;
                            select.innerHTML = '<option value="">انتخاب کنید</option>';
                            
                            // اضافه کردن دسته بندی ها
                            this.currentUser.categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                select.appendChild(option);
                            });
                            
                            // بازگرداندن مقدار قبلی اگر هنوز وجود دارد
                            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                                select.value = currentValue;
                            }
                        }
                    });
                },
                
                updateUserProductsChecklist() {
                    if (!this.currentUser) return;
                    
                    const checklist = document.getElementById('productsChecklist');
                    if (!checklist) return;
                    
                    checklist.innerHTML = '';
                    
                    const availableProducts = this.currentUser.products ? this.currentUser.products.filter(p => !p.isSold && p.stock > 0) : [];
                    
                    if (availableProducts.length === 0) {
                        checklist.innerHTML = '<div class="empty-state"><i class="ti ti-package"></i><p>هیچ محصولی برای فروش موجود نیست</p></div>';
                        return;
                    }
                    
                    availableProducts.forEach(product => {
                        const checkboxItem = document.createElement('div');
                        checkboxItem.className = 'checkbox-item';
                        checkboxItem.innerHTML = `
                            <input type="checkbox" id="product_${product.id}" value="${product.id}">
                            <label for="product_${product.id}">
                                ${product.name} - ${product.price.toLocaleString('fa-IR')} افغانی (موجودی: ${product.stock})
                            </label>
                        `;
                        checklist.appendChild(checkboxItem);
                    });
                },
                
                getUserCategoryName(categoryId) {
                    if (!this.currentUser || !this.currentUser.categories) return 'نامشخص';
                    const category = this.currentUser.categories.find(c => c.id == categoryId);
                    return category ? category.name : 'نامشخص';
                },
                
                async handleAddProduct(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const name = document.getElementById('productName').value;
                    const category = document.getElementById('productCategory').value;
                    const price = parseInt(document.getElementById('productPrice').value);
                    const stock = parseInt(document.getElementById('productStock').value);
                    const description = document.getElementById('productDescription').value;
                    
                    if (!name || !category || !price || !stock) {
                        this.showNotification('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
                        return;
                    }
                    
                    const newProduct = {
                        id: Date.now(),
                        name,
                        category,
                        price,
                        stock,
                        description,
                        isSold: false
                    };
                    
                    if (!this.currentUser.products) {
                        this.currentUser.products = [];
                    }
                    this.currentUser.products.push(newProduct);
                    
                    // بهروزرسانی تعداد محصولات در دسته بندی
                    if (this.currentUser.categories) {
                        const categoryObj = this.currentUser.categories.find(c => c.id == category);
                        if (categoryObj) {
                            categoryObj.productCount = (categoryObj.productCount || 0) + 1;
                        }
                    }
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        document.getElementById('productForm').reset();
                        this.showNotification('محصول با موفقیت اضافه شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `➕ محصول جدید اضافه شد\n\n` +
                            `نام: ${name}\n` +
                            `قیمت: ${price.toLocaleString('fa-IR')} افغانی\n` +
                            `موجودی: ${stock}\n` +
                            `دسته بندی: ${this.getUserCategoryName(category)}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در ذخیره محصول', 'error');
                    }
                },
                
                async handleAddCategory(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const name = document.getElementById('categoryName').value;
                    
                    if (!name) {
                        this.showNotification('لطفا نام دسته بندی را وارد کنید', 'error');
                        return;
                    }
                    
                    const newCategory = {
                        id: Date.now(),
                        name,
                        productCount: 0
                    };
                    
                    if (!this.currentUser.categories) {
                        this.currentUser.categories = [];
                    }
                    this.currentUser.categories.push(newCategory);
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        document.getElementById('categoryForm').reset();
                        this.showNotification('دسته بندی با موفقیت اضافه شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `📁 دسته بندی جدید اضافه شد\n\n` +
                            `نام: ${name}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در ذخیره دسته بندی', 'error');
                    }
                },
                
                openEditProductModal(productId) {
                    if (!this.currentUser || !this.currentUser.products) return;
                    
                    const product = this.currentUser.products.find(p => p.id === productId);
                    if (!product) return;
                    
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editProductName').value = product.name;
                    document.getElementById('editProductCategory').value = product.category;
                    document.getElementById('editProductPrice').value = product.price;
                    document.getElementById('editProductStock').value = product.stock;
                    document.getElementById('editProductDescription').value = product.description || '';
                    
                    // مطمئن شویم dropdownها پر شدهاند
                    this.populateUserCategoryDropdowns();
                    
                    document.getElementById('editProductModal').style.display = 'flex';
                },
                
                async handleEditProduct(e) {
                    e.preventDefault();
                    if (!this.currentUser || !this.currentUser.products) return;
                    
                    const productId = parseInt(document.getElementById('editProductId').value);
                    const name = document.getElementById('editProductName').value;
                    const category = document.getElementById('editProductCategory').value;
                    const price = parseInt(document.getElementById('editProductPrice').value);
                    const stock = parseInt(document.getElementById('editProductStock').value);
                    const description = document.getElementById('editProductDescription').value;
                    
                    if (!name || !category || !price || !stock) {
                        this.showNotification('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
                        return;
                    }
                    
                    const productIndex = this.currentUser.products.findIndex(p => p.id === productId);
                    if (productIndex === -1) return;
                    
                    // ذخیره وضعیت قبلی برای بهروزرسانی آمار دسته بندی
                    const oldCategory = this.currentUser.products[productIndex].category;
                    
                    // بهروزرسانی محصول
                    this.currentUser.products[productIndex] = {
                        ...this.currentUser.products[productIndex],
                        name,
                        category,
                        price,
                        stock,
                        description
                    };
                    
                    // بهروزرسانی آمار دسته بندی ها
                    if (oldCategory !== category) {
                        const oldCategoryObj = this.currentUser.categories.find(c => c.id == oldCategory);
                        if (oldCategoryObj) {
                            oldCategoryObj.productCount = Math.max(0, (oldCategoryObj.productCount || 0) - 1);
                        }
                        
                        const newCategoryObj = this.currentUser.categories.find(c => c.id == category);
                        if (newCategoryObj) {
                            newCategoryObj.productCount = (newCategoryObj.productCount || 0) + 1;
                        }
                    }
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        this.closeAllModals();
                        this.showNotification('محصول با موفقیت ویرایش شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `✏️ محصول ویرایش شد\n\n` +
                            `نام: ${name}\n` +
                            `قیمت جدید: ${price.toLocaleString('fa-IR')} افغانی\n` +
                            `موجودی جدید: ${stock}\n` +
                            `دسته بندی: ${this.getUserCategoryName(category)}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در ویرایش محصول', 'error');
                    }
                },
                
                async deleteUserProduct(productId) {
                    if (!this.currentUser || !this.currentUser.products) return;
                    
                    if (!confirm('آیا از حذف این محصول اطمینان دارید؟')) return;
                    
                    const productIndex = this.currentUser.products.findIndex(p => p.id === productId);
                    if (productIndex === -1) return;
                    
                    const product = this.currentUser.products[productIndex];
                    
                    // بهروزرسانی آمار دسته بندی
                    if (this.currentUser.categories) {
                        const categoryObj = this.currentUser.categories.find(c => c.id == product.category);
                        if (categoryObj) {
                            categoryObj.productCount = Math.max(0, (categoryObj.productCount || 0) - 1);
                        }
                    }
                    
                    // حذف محصول
                    this.currentUser.products.splice(productIndex, 1);
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        this.showNotification('محصول با موفقیت حذف شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `🗑️ محصول حذف شد\n\n` +
                            `نام: ${product.name}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در حذف محصول', 'error');
                    }
                },
                
                async deleteUserCategory(categoryId) {
                    if (!this.currentUser || !this.currentUser.categories) return;
                    
                    if (!confirm('آیا از حذف این دسته بندی اطمینان دارید؟ محصولات مرتبط نیز حذف خواهند شد.')) return;
                    
                    const categoryIndex = this.currentUser.categories.findIndex(c => c.id === categoryId);
                    if (categoryIndex === -1) return;
                    
                    const category = this.currentUser.categories[categoryIndex];
                    
                    // حذف دسته بندی
                    this.currentUser.categories.splice(categoryIndex, 1);
                    
                    // حذف محصولات مرتبط
                    if (this.currentUser.products) {
                        this.currentUser.products = this.currentUser.products.filter(p => p.category != categoryId);
                    }
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        this.showNotification('دسته بندی با موفقیت حذف شد', 'success');
                    } catch (error) {
                        this.showNotification('خطا در حذف دسته بندی', 'error');
                    }
                },
                
                async markProductsAsSold() {
                    if (!this.currentUser || !this.currentUser.products) return;
                    
                    const checkboxes = document.querySelectorAll('#productsChecklist input[type="checkbox"]:checked');
                    if (checkboxes.length === 0) {
                        this.showNotification('هیچ محصولی انتخاب نشده است', 'warning');
                        return;
                    }
                    
                    const soldProducts = [];
                    let totalAmount = 0;
                    
                    checkboxes.forEach(checkbox => {
                        const productId = parseInt(checkbox.value);
                        const productIndex = this.currentUser.products.findIndex(p => p.id === productId);
                        
                        if (productIndex !== -1) {
                            const product = this.currentUser.products[productIndex];
                            
                            // کاهش موجودی
                            if (product.stock > 0) {
                                product.stock -= 1;
                                
                                // اگر موجودی صفر شد، وضعیت را به فروخته شده تغییر دهید
                                if (product.stock === 0) {
                                    product.isSold = true;
                                }
                                
                                // اضافه کردن به لیست فروش ها
                                if (!this.currentUser.sold_items) {
                                    this.currentUser.sold_items = [];
                                }
                                
                                this.currentUser.sold_items.push({
                                    productId: product.id,
                                    productName: product.name,
                                    category: product.category,
                                    price: product.price,
                                    soldAt: new Date().toISOString()
                                });
                                
                                soldProducts.push(product);
                                totalAmount += product.price;
                            }
                        }
                    });
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        
                        this.showNotification(
                            `${soldProducts.length} محصول با موفقیت به عنوان فروخته شده ثبت شد`,
                            'success'
                        );
                        
                        // ارسال پیام به تلگرام
                        if (soldProducts.length === 1) {
                            this.sendToUserTelegram(
                                `💰 فروش جدید ثبت شد\n\n` +
                                `محصول: ${soldProducts[0].name}\n` +
                                `قیمت: ${soldProducts[0].price.toLocaleString('fa-IR')} افغانی\n` +
                                `دسته بندی: ${this.getUserCategoryName(soldProducts[0].category)}\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        } else {
                            this.sendToUserTelegram(
                                `💰 فروش چندگانه ثبت شد\n\n` +
                                `تعداد محصولات: ${soldProducts.length}\n` +
                                `جمع مبلغ: ${totalAmount.toLocaleString('fa-IR')} افغانی\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        }
                    } catch (error) {
                        this.showNotification('خطا در ثبت فروش', 'error');
                    }
                },
                
                async returnProduct(soldItemIndex) {
                    if (!this.currentUser || !this.currentUser.sold_items) return;
                    
                    if (!confirm('آیا از بازگرداندن این محصول اطمینان دارید؟')) return;
                    
                    const soldItem = this.currentUser.sold_items[soldItemIndex];
                    
                    // بازگرداندن وضعیت محصول
                    if (this.currentUser.products) {
                        const productIndex = this.currentUser.products.findIndex(p => p.id === soldItem.productId);
                        if (productIndex !== -1) {
                            this.currentUser.products[productIndex].stock += 1;
                            this.currentUser.products[productIndex].isSold = false;
                        }
                    }
                    
                    // حذف از لیست فروش ها
                    this.currentUser.sold_items.splice(soldItemIndex, 1);
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        this.showNotification('محصول با موفقیت بازگردانده شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `↩️ محصول بازگردانده شد\n\n` +
                            `محصول: ${soldItem.productName}\n` +
                            `قیمت: ${soldItem.price.toLocaleString('fa-IR')} افغانی\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در بازگرداندن محصول', 'error');
                    }
                },
                
                // توابع جدید برای مدیریت صرافی
                renderExchangeRates() {
                    if (!this.currentUser) return;
                    
                    const container = document.getElementById('exchangeRatesContainer');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    // ایجاد نرخهای ارز پیشفرض اگر وجود ندارند
                    if (!this.currentUser.exchange_rates) {
                        this.currentUser.exchange_rates = {
                            USD: 85,
                            EUR: 95,
                            GBP: 110,
                            AED: 23,
                            PKR: 0.3,
                            IRR: 0.002
                        };
                    }
                    
                    this.currencies.forEach(currency => {
                        const rateDiv = document.createElement('div');
                        rateDiv.className = 'form-group';
                        rateDiv.innerHTML = `
                            <label for="rate_${currency}">نرخ ${currency} به AFN:</label>
                            <div class="exchange-rate">
                                <input type="number" id="rate_${currency}" value="${this.currentUser.exchange_rates[currency] || 0}" step="0.01" min="0">
                                <span>${currency} = 1 AFN</span>
                            </div>
                        `;
                        container.appendChild(rateDiv);
                    });
                },
                
                async saveExchangeRates() {
                    if (!this.currentUser) return;
                    
                    const rates = {};
                    this.currencies.forEach(currency => {
                        const rateInput = document.getElementById(`rate_${currency}`);
                        if (rateInput) {
                            rates[currency] = parseFloat(rateInput.value) || 0;
                        }
                    });
                    
                    this.currentUser.exchange_rates = rates;
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.showNotification('نرخهای ارز با موفقیت ذخیره شد', 'success');
                    } catch (error) {
                        this.showNotification('خطا در ذخیره نرخهای ارز', 'error');
                    }
                },
                
                calculateExchange() {
                    if (!this.currentUser || !this.currentUser.exchange_rates) return;
                    
                    const amount = parseFloat(document.getElementById('calcAmount').value);
                    const fromCurrency = document.getElementById('calcFrom').value;
                    const toCurrency = document.getElementById('calcTo').value;
                    
                    if (!amount || amount <= 0) {
                        this.showNotification('لطفا مبلغ معتبر وارد کنید', 'error');
                        return;
                    }
                    
                    let result;
                    
                    if (fromCurrency === 'AFN') {
                        // تبدیل از افغانی به ارز دیگر
                        result = amount / (this.currentUser.exchange_rates[toCurrency] || 1);
                    } else if (toCurrency === 'AFN') {
                        // تبدیل از ارز دیگر به افغانی
                        result = amount * (this.currentUser.exchange_rates[fromCurrency] || 1);
                    } else {
                        // تبدیل بین دو ارز خارجی
                        const toAfn = amount * (this.currentUser.exchange_rates[fromCurrency] || 1);
                        result = toAfn / (this.currentUser.exchange_rates[toCurrency] || 1);
                    }
                    
                    document.getElementById('calcResult').value = result.toFixed(2);
                },
                
                async saveBusinessSettings() {
                    if (!this.currentUser) return;
                    
                    const address = document.getElementById('businessAddress').value;
                    const phone = document.getElementById('businessPhone').value;
                    const description = document.getElementById('businessDescription').value;
                    
                    this.currentUser.business_address = address;
                    this.currentUser.business_phone = phone;
                    this.currentUser.business_description = description;
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.showNotification('تنظیمات تجارت با موفقیت ذخیره شد', 'success');
                    } catch (error) {
                        this.showNotification('خطا در ذخیره تنظیمات تجارت', 'error');
                    }
                },
                
                async saveTelegramSettings() {
                    if (!this.currentUser) return;
                    
                    const token = document.getElementById('userTelegramToken').value;
                    const chatId = document.getElementById('userTelegramChatId').value;
                    
                    this.currentUser.telegram_bot_token = token;
                    this.currentUser.telegram_chat_id = chatId;
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.showNotification('تنظیمات تلگرام ذخیره شد', 'success');
                        
                        // تست ارسال پیام
                        if (token && chatId) {
                            this.sendToUserTelegram('✅ تنظیمات تلگرام با موفقیت ذخیره شد. این پیام تستی است.');
                        }
                    } catch (error) {
                        this.showNotification('خطا در ذخیره تنظیمات تلگرام', 'error');
                    }
                },
                
                async sendToUserTelegram(message) {
                    if (!this.currentUser || !this.currentUser.telegram_bot_token || !this.currentUser.telegram_chat_id) {
                        this.updateTelegramStatus('تنظیمات تلگرام کاربر تعریف نشده است', 'error');
                        return false;
                    }
                    
                    try {
                        const url = `https://api.telegram.org/bot${this.currentUser.telegram_bot_token}/sendMessage`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: this.currentUser.telegram_chat_id,
                                text: message,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.ok) {
                            this.updateTelegramStatus('پیام ارسال شد', 'active');
                            return true;
                        } else {
                            this.updateTelegramStatus('خطا در ارسال: ' + result.description, 'error');
                            return false;
                        }
                    } catch (error) {
                        console.error('خطا در ارسال به تلگرام:', error);
                        this.updateTelegramStatus('خطا در اتصال به تلگرام', 'error');
                        return false;
                    }
                },
                
                async sendToAdminTelegram(message) {
                    try {
                        const url = `https://api.telegram.org/bot${SYSTEM_CONFIG.telegramBotToken}/sendMessage`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: SYSTEM_CONFIG.telegramChatId,
                                text: message,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const result = await response.json();
                        return result.ok;
                    } catch (error) {
                        console.error('خطا در ارسال به تلگرام مدیر:', error);
                        return false;
                    }
                },
                
                updateTelegramStatus(message, type = '') {
                    const statusElement = document.getElementById('telegramStatusText');
                    const statusContainer = document.getElementById('telegramStatus');
                    
                    if (statusElement && statusContainer) {
                        statusElement.textContent = message;
                        statusContainer.className = 'telegram-status';
                        if (type) {
                            statusContainer.classList.add(type);
                        }
                        
                        // بعد از 5 ثانیه وضعیت را به حالت عادی برگردان
                        setTimeout(() => {
                            statusElement.textContent = 'آماده';
                            statusContainer.className = 'telegram-status';
                        }, 5000);
                    }
                },
                
                backupData() {
                    if (!this.currentUser) return;
                    
                    const data = {
                        user: this.currentUser,
                        backupDate: new Date().toISOString(),
                        system: 'Store Management System'
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${this.currentUser.store_name}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('پشتیبان با موفقیت دانلود شد', 'success');
                },
                
                triggerRestore() {
                    document.getElementById('restoreFile').click();
                },
                
                async restoreData(e) {
                    if (!this.currentUser) return;
                    
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (data.user && data.system === 'Store Management System') {
                                // جایگزینی داده های کاربر
                                this.currentUser = data.user;
                                
                                try {
                                    await this.saveUserToCloud(this.currentUser);
                                    this.renderUserDashboard();
                                    this.showNotification('دادهها با موفقیت بازیابی شدند', 'success');
                                } catch (error) {
                                    this.showNotification('خطا در ذخیره دادههای بازیابی شده', 'error');
                                }
                            } else {
                                this.showNotification('فایل پشتیبان معتبر نیست', 'error');
                            }
                        } catch (error) {
                            console.error('خطا در بازیابی داده ها:', error);
                            this.showNotification('خطا در بازیابی داده ها', 'error');
                        }
                    };
                    reader.readAsText(file);
                    
                    // ریست کردن input فایل
                    e.target.value = '';
                },
                
                async clearData() {
                    if (!this.currentUser) return;
                    
                    if (!confirm('آیا از پاک کردن تمام داده های خود اطمینان دارید؟ این عمل غیرقابل برگشت است.')) return;
                    
                    // حفظ اطلاعات پایه کاربر
                    const userBase = {
                        store_name: this.currentUser.store_name,
                        owner_name: this.currentUser.owner_name,
                        email: this.currentUser.email,
                        password: this.currentUser.password,
                        business_type: this.currentUser.business_type,
                        approved: this.currentUser.approved,
                        telegram_bot_token: this.currentUser.telegram_bot_token,
                        telegram_chat_id: this.currentUser.telegram_chat_id,
                        business_address: this.currentUser.business_address,
                        business_phone: this.currentUser.business_phone,
                        business_description: this.currentUser.business_description
                    };
                    
                    // ریست کردن داده ها
                    this.currentUser = {
                        ...userBase,
                        products: [],
                        categories: [
                            { id: 1, name: "الکترونیک", productCount: 0 },
                            { id: 2, name: "مواد غذایی", productCount: 0 },
                            { id: 3, name: "لوازم خانگی", productCount: 0 },
                            { id: 4, name: "پوشاک", productCount: 0 }
                        ],
                        sold_items: [],
                        exchange_rates: {
                            USD: 85,
                            EUR: 95,
                            GBP: 110,
                            AED: 23,
                            PKR: 0.3,
                            IRR: 0.002
                        }
                    };
                    
                    try {
                        await this.saveUserToCloud(this.currentUser);
                        this.renderUserDashboard();
                        this.showNotification('تمامی داده ها پاک شدند', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `🔄 داده ها بازنشانی شدند\n\n` +
                            `تمامی محصولات، دسته بندی ها و تاریخچه فروش پاک شدند.\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        this.showNotification('خطا در پاک کردن دادهها', 'error');
                    }
                },
                
                printProducts() {
                    if (!this.currentUser) return;
                    
                    const printArea = document.getElementById('printArea');
                    printArea.innerHTML = '';
                    
                    let content = `
                        <div class="print-header" style="text-align: center; margin-bottom: 30px;">
                            <h2>گزارش محصولات</h2>
                            <p>تجارت: ${this.currentUser.store_name}</p>
                            <p>تاریخ: ${new Date().toLocaleDateString('fa-IR')}</p>
                        </div>
                        <table class="print-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">نام محصول</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">دسته بندی</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">قیمت (افغانی)</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">موجودی</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">وضعیت</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    if (this.currentUser.products) {
                        this.currentUser.products.forEach(product => {
                            content += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${product.name}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${this.getUserCategoryName(product.category)}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${product.price.toLocaleString('fa-IR')}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${product.stock}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${product.isSold ? 'فروخته شده' : 'موجود'}</td>
                                </tr>
                            `;
                        });
                    }
                    
                    content += `
                            </tbody>
                        </table>
                        <div class="print-footer" style="text-align: center; margin-top: 30px;">
                            <p>تعداد کل محصولات: ${this.currentUser.products ? this.currentUser.products.length : 0}</p>
                            <p>سیستم مدیریت تجارت - نسخه ${SYSTEM_CONFIG.version}</p>
                        </div>
                    `;
                    
                    printArea.innerHTML = content;
                    printArea.style.display = 'block';
                    window.print();
                    printArea.style.display = 'none';
                },
                
                exportProducts() {
                    if (!this.currentUser || !this.currentUser.products) return;
                    
                    const productsData = this.currentUser.products.map(product => ({
                        نام: product.name,
                        دستهبندی: this.getUserCategoryName(product.category),
                        قیمت: product.price,
                        موجودی: product.stock,
                        وضعیت: product.isSold ? 'فروخته شده' : 'موجود',
                        توضیحات: product.description || ''
                    }));
                    
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
                        + "نام,دستهبندی,قیمت,موجودی,وضعیت,توضیحات\n"
                        + productsData.map(row => 
                            `"${row.نام}","${row.دستهبندی}",${row.قیمت},${row.موجودی},"${row.وضعیت}","${row.توضیحات}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `محصولات_${this.currentUser.store_name}_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('خروجی CSV با موفقیت دانلود شد', 'success');
                },
                
                closeAllModals() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                },
                
                switchUserTab(tabName) {
                    // مخفی کردن تمام تبها
                    document.querySelectorAll('.user-tab').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // غیرفعال کردن تمام تبها
                    document.querySelectorAll('#userDashboard .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // نمایش تب انتخاب شده
                    const targetTab = document.getElementById(`user${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    }
                    
                    // فعال کردن تب انتخاب شده
                    const activeTab = document.querySelector(`#userDashboard .tab[data-tab="${tabName}"]`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                },
                
                switchAdminTab(tabName) {
                    // مخفی کردن تمام تبها
                    document.querySelectorAll('.admin-tab').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // غیرفعال کردن تمام تبها
                    document.querySelectorAll('#adminDashboard .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // نمایش تب انتخاب شده
                    const targetTab = document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    }
                    
                    // فعال کردن تب انتخاب شده
                    const activeTab = document.querySelector(`#adminDashboard .tab[data-tab="${tabName}"]`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                },
                
                // مدیریت پنل ادمین
                renderAdminDashboard() {
                    this.updateAdminStats();
                    this.renderStoresList();
                    this.renderApprovalList();
                    this.renderUserCredentials();
                },
                
                updateAdminStats() {
                    document.getElementById('adminTotalStores').textContent = this.users.length;
                    document.getElementById('adminTotalProducts').textContent = this.users.reduce((total, user) => total + (user.products ? user.products.length : 0), 0);
                    document.getElementById('adminTotalSales').textContent = this.users.reduce((total, user) => total + (user.sold_items ? user.sold_items.length : 0), 0);
                    
                    // محاسبه تجارت های جدید (ایجاد شده در 7 روز گذشته)
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    const newStores = this.users.filter(user => {
                        const createdDate = user.created_at ? new Date(user.created_at) : new Date();
                        return createdDate > oneWeekAgo;
                    }).length;
                    document.getElementById('adminNewStores').textContent = newStores;
                },
                
                renderStoresList() {
                    const storesList = document.getElementById('storesList');
                    if (!storesList) return;
                    
                    storesList.innerHTML = '';
                    
                    if (this.users.length === 0) {
                        storesList.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ تجارتی ثبت نام نکرده است</p>';
                        return;
                    }
                    
                    this.users.forEach(user => {
                        const storeItem = document.createElement('div');
                        storeItem.className = 'store-item';
                        storeItem.innerHTML = `
                            <div class="store-info">
                                <div class="store-name">${user.store_name}</div>
                                <div class="store-email">${user.email} - ${user.owner_name}</div>
                                <div class="store-details">
                                    نوع: ${this.businessTypes[user.business_type] || 'نامشخص'} | 
                                    محصولات: ${user.products ? user.products.length : 0} | 
                                    دسته بندی ها: ${user.categories ? user.categories.length : 0} | 
                                    فروش: ${user.sold_items ? user.sold_items.length : 0}
                                </div>
                            </div>
                            <div class="store-actions">
                                <button class="btn-info" onclick="SystemState.viewStoreDetails('${user.id}')">مشاهده</button>
                                <button class="btn-warning" onclick="SystemState.editStore('${user.id}')">ویرایش</button>
                                <button class="btn-danger" onclick="SystemState.deleteStore('${user.id}')">حذف</button>
                            </div>
                        `;
                        storesList.appendChild(storeItem);
                    });
                },
                
                renderApprovalList() {
                    const approvalList = document.getElementById('approvalList');
                    if (!approvalList) return;
                    
                    approvalList.innerHTML = '';
                    
                    if (this.pendingApprovals.length === 0) {
                        approvalList.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ درخواست تأییدی در انتظار نیست</p>';
                        return;
                    }
                    
                    this.pendingApprovals.forEach((user, index) => {
                        const approvalItem = document.createElement('div');
                        approvalItem.className = 'approval-item';
                        approvalItem.innerHTML = `
                            <div class="approval-info">
                                <div class="store-name">${user.store_name}</div>
                                <div class="store-email">${user.email} - ${user.owner_name}</div>
                                <div class="store-details">
                                    نوع: ${this.businessTypes[user.business_type] || 'نامشخص'} | 
                                    تاریخ ثبتنام: ${user.created_at ? new Date(user.created_at).toLocaleDateString('fa-IR') : 'نامشخص'}
                                </div>
                            </div>
                            <div class="approval-actions">
                                <button class="btn-success" onclick="SystemState.approveUser('${user.id}')">تأیید</button>
                                <button class="btn-danger" onclick="SystemState.rejectUser('${user.id}')">رد</button>
                            </div>
                        `;
                        approvalList.appendChild(approvalItem);
                    });
                },
                
                renderUserCredentials() {
                    const userCredentialsTable = document.getElementById('userCredentialsTable');
                    if (!userCredentialsTable) return;
                    
                    userCredentialsTable.innerHTML = '';
                    
                    // نمایش کاربران تأیید شده
                    this.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.store_name}</td>
                            <td>${this.businessTypes[user.business_type] || 'نامشخص'}</td>
                            <td>${user.owner_name}</td>
                            <td>${user.email}</td>
                            <td><span class="user-status status-approved">تأیید شده</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('fa-IR') : 'نامشخص'}</td>
                            <td>${user.google_id ? 'گوگل' : 'ایمیل/رمز عبور'}</td>
                        `;
                        userCredentialsTable.appendChild(row);
                    });
                    
                    // نمایش کاربران در انتظار تأیید
                    this.pendingApprovals.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.store_name}</td>
                            <td>${this.businessTypes[user.business_type] || 'نامشخص'}</td>
                            <td>${user.owner_name}</td>
                            <td>${user.email}</td>
                            <td><span class="user-status status-pending">در انتظار تأیید</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('fa-IR') : 'نامشخص'}</td>
                            <td>${user.google_id ? 'گوگل' : 'ایمیل/رمز عبور'}</td>
                        `;
                        userCredentialsTable.appendChild(row);
                    });
                    
                    // اگر هیچ کاربری وجود ندارد
                    if (this.users.length === 0 && this.pendingApprovals.length === 0) {
                        userCredentialsTable.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-light);">
                                    هیچ کاربری ثبت نام نکرده است
                                </td>
                            </tr>
                        `;
                    }
                },
                
                async approveUser(userId) {
                    try {
                        const userIndex = this.pendingApprovals.findIndex(u => u.id == userId);
                        if (userIndex === -1) return;
                        
                        const user = this.pendingApprovals[userIndex];
                        user.approved = true;
                        
                        const { error } = await this.supabase
                            .from('businesses')
                            .update({ approved: true })
                            .eq('id', userId);
                        
                        if (error) throw error;
                        
                        // بهروزرسانی لیستهای محلی
                        this.pendingApprovals.splice(userIndex, 1);
                        this.users.push(user);
                        
                        this.renderAdminDashboard();
                        
                        // ارسال پیام به مدیر
                        this.sendToAdminTelegram(
                            `✅ کاربر تأیید شد\n\n` +
                            `تجارت: ${user.store_name}\n` +
                            `نوع: ${this.businessTypes[user.business_type] || 'نامشخص'}\n` +
                            `صاحب: ${user.owner_name}\n` +
                            `ایمیل: ${user.email}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                        
                        this.showNotification(`تجارت ${user.store_name} با موفقیت تأیید شد`, 'success');
                    } catch (error) {
                        console.error('خطا در تأیید کاربر:', error);
                        this.showNotification('خطا در تأیید کاربر', 'error');
                    }
                },
                
                async rejectUser(userId) {
                    try {
                        const userIndex = this.pendingApprovals.findIndex(u => u.id == userId);
                        if (userIndex === -1) return;
                        
                        const user = this.pendingApprovals[userIndex];
                        
                        const { error } = await this.supabase
                            .from('businesses')
                            .delete()
                            .eq('id', userId);
                        
                        if (error) throw error;
                        
                        // بهروزرسانی لیستهای محلی
                        this.pendingApprovals.splice(userIndex, 1);
                        
                        this.renderAdminDashboard();
                        this.showNotification(`درخواست ${user.store_name} رد شد`, 'error');
                    } catch (error) {
                        console.error('خطا در رد کاربر:', error);
                        this.showNotification('خطا در رد کاربر', 'error');
                    }
                },
                
                viewStoreDetails(userId) {
                    const user = this.users.find(u => u.id == userId);
                    if (user) {
                        alert(`جزئیات تجارت:\n\nنام: ${user.store_name}\nنوع: ${this.businessTypes[user.business_type] || 'نامشخص'}\nصاحب: ${user.owner_name}\nایمیل: ${user.email}\nمحصولات: ${user.products ? user.products.length : 0}\nدسته بندی ها: ${user.categories ? user.categories.length : 0}\nفروش ها: ${user.sold_items ? user.sold_items.length : 0}`);
                    }
                },
                
                editStore(userId) {
                    const user = this.users.find(u => u.id == userId);
                    if (user) {
                        // در اینجا میتوانید یک مودال برای ویرایش اطلاعات تجارت ایجاد کنید
                        alert(`ویرایش اطلاعات تجارت ${user.store_name}\n\nاین قابلیت در نسخههای آینده اضافه خواهد شد.`);
                    }
                },
                
                async deleteStore(userId) {
                    const user = this.users.find(u => u.id == userId);
                    if (user && confirm(`آیا از حذف تجارت ${user.store_name} اطمینان دارید؟ تمام داده های مربوط به این تجارت حذف خواهند شد.`)) {
                        try {
                            const { error } = await this.supabase
                                .from('businesses')
                                .delete()
                                .eq('id', userId);
                            
                            if (error) throw error;
                            
                            this.users = this.users.filter(u => u.id !== userId);
                            this.renderAdminDashboard();
                            
                            this.showNotification(`تجارت ${user.store_name} حذف شد`, 'success');
                        } catch (error) {
                            console.error('خطا در حذف تجارت:', error);
                            this.showNotification('خطا در حذف تجارت', 'error');
                        }
                    }
                },
                
                openCreateStoreModal() {
                    document.getElementById('createStoreModal').style.display = 'flex';
                },
                
                backupAllData() {
                    const data = {
                        users: this.users,
                        pendingApprovals: this.pendingApprovals,
                        backupDate: new Date().toISOString(),
                        system: 'Store Management System'
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-all-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('پشتیبان از تمام داده ها با موفقیت دانلود شد', 'success');
                },
                
                async resetAllData() {
                    if (confirm('آیا از بازنشانی تمام داده های سیستم اطمینان دارید؟ این عمل تمام کاربران، محصولات و تاریخچه را پاک میکند و غیرقابل برگشت است.')) {
                        try {
                            // حذف تمام دادهها از Supabase
                            const { error } = await this.supabase
                                .from('businesses')
                                .delete()
                                .neq('id', 0); // حذف تمام رکوردها
                            
                            if (error) throw error;
                            
                            this.users = [];
                            this.pendingApprovals = [];
                            this.currentUser = null;
                            this.isAdmin = false;
                            await this.createDefaultUser();
                            this.showAppropriatePage();
                            
                            this.showNotification('تمامی داده های سیستم بازنشانی شدند', 'success');
                        } catch (error) {
                            console.error('خطا در بازنشانی دادهها:', error);
                            this.showNotification('خطا در بازنشانی دادهها', 'error');
                        }
                    }
                },
                
                viewAllData() {
                    const allData = {
                        users: this.users,
                        pendingApprovals: this.pendingApprovals,
                        adminCredentials: this.adminCredentials
                    };
                    
                    alert('دادههای سیستم:\n\n' + JSON.stringify(allData, null, 2));
                },
                
                showNotification(message, type = 'info') {
                    // حذف نوتیفیکیشنهای قبلی
                    document.querySelectorAll('.notification').forEach(notification => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    });
                    
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.innerHTML = `
                        <i class="ti ti-${type === 'success' ? 'circle-check' : type === 'error' ? 'alert-circle' : type === 'warning' ? 'alert-triangle' : 'info-circle'}"></i>
                        ${message}
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                },
                
                // توابع جدید برای رفع خطاها
                editUserCategory(categoryId) {
                    const category = this.currentUser.categories.find(c => c.id === categoryId);
                    if (category) {
                        const newName = prompt('نام جدید دسته بندی را وارد کنید:', category.name);
                        if (newName && newName.trim() !== '') {
                            category.name = newName.trim();
                            this.saveUserToCloud(this.currentUser);
                            this.renderUserDashboard();
                            this.showNotification('دسته بندی ویرایش شد', 'success');
                        }
                    }
                },
                
                editCategory(categoryId) {
                    this.editUserCategory(categoryId);
                },
                
                initiateGoogleSignIn() {
                    // این تابع برای احراز هویت گوگل استفاده میشود
                    // در نسخه واقعی باید با Google Identity Services یکپارچه شود
                    this.showNotification('ورود با گوگل در حال توسعه است', 'info');
                }
            };
            
            // مقداردهی اولیه سیستم
            document.addEventListener('DOMContentLoaded', function() {
                SystemState.init();
            });
            
            // در معرض قرار دادن SystemState برای استفاده در onclickها
            window.SystemState = SystemState;
        })();
    </script>
</body>
</html>
